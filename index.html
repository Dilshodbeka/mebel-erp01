<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mebel ERP Elite - Smart System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>    
    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --border: #e2e8f0; --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 40px; }
        
        /* Navigation */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-top: 90px; }
        .nav { background: #fff; padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        .nav-brand { font-weight: 800; font-size: 24px; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        
        .nav-links { display: none; gap: 8px; }
        .tab-btn { padding: 8px 16px; border: none; background: none; cursor: pointer; font-weight: 500; color: #64748b; border-radius: 8px; transition: all 0.2s; font-size: 14px; }
        .tab-btn.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .tab-btn:hover:not(.active) { background: #f8fafc; color: var(--text); }

        /* Components */
        .card { background: var(--card); padding: 24px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); transition: transform 0.2s; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .stat-val { font-size: 32px; font-weight: 800; color: var(--text); }
        .stat-label { font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Grids */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin: 16px 0; }
        .item-card { border: 1px solid var(--border); padding: 14px; border-radius: 12px; transition: 0.2s; background: #fff; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; }
        .item-card:hover { border-color: var(--primary); background: #eef2ff; transform: translateY(-2px); }
        .item-card input { margin: 0; width: auto; height: 16px; width: 16px; }

        /* Inputs & Buttons */
        input, select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 15px; margin-bottom: 12px; transition: 0.2s; background: #fff; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        button { padding: 12px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        button:active { transform: scale(0.98); }
        
        .btn-blue { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-blue:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-green { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
        .btn-green:hover { filter: brightness(1.1); }
        .btn-red { background: var(--danger); color: white; }
        .btn-ghost { background: #f1f5f9; color: #64748b; }
        .btn-ghost:hover { background: #e2e8f0; color: var(--text); }

        /* Tables */
        .table-wrapper { overflow-x: auto; }
        .modern-table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        .modern-table th { background: #f8fafc; text-align: left; padding: 14px; border-bottom: 2px solid var(--border); color: #64748b; font-size: 12px; font-weight: 600; }
        .modern-table td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        /* Badges */
        .proc-badge { display: inline-flex; align-items: center; padding: 4px 10px; margin: 2px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #f8fafc; border: 1px solid var(--border); }
        .proc-badge.finished { background: #ecfdf5; border-color: #10b981; color: #065f46; }
        .proc-badge.active { background: #eef2ff; border-color: #4f46e5; color: #3730a3; }

        /* Smart Task List */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .task-item:hover { border-color: var(--primary); background: #f8fafc; }
        .task-item.priority { border-left: 4px solid var(--warning); }

        /* Hidden & Utilities */
        .hidden { display: none !important; }
        .edit-mode-active { border: 2px solid var(--warning) !important; background: #fffbeb !important; }
        
        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; padding: 16px; background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; font-size: 14px; font-weight: 500; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: var(--radius); max-width: 500px; width: 100%; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    	/* --- MOBILE OPTIMIZATIONS --- */
@media (max-width: 768px) {
    /* Stack grids on mobile */
    .grid { grid-template-columns: 1fr; } 
    .stats-grid { grid-template-columns: 1fr; }
    
    /* Make Nav scrollable on small screens */
    .nav { padding: 10px; }
    .nav-brand { font-size: 18px; }
    
    /* Fix Admin Nav on mobile */
    #admin-nav { 
        display: none; /* Hidden by default */
        position: absolute; 
        top: 60px; 
        left: 0; 
        width: 100%; 
        background: white; 
        padding: 10px; 
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap; 
    }
    #admin-nav.mobile-active { display: flex; }
    
    /* Tables need horizontal scroll on mobile */
    .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    
    /* Adjust Card Padding */
    .card { padding: 15px; }
    
    /* Toast adjustments */
    .toast { left: 20px; right: 20px; width: auto; min-width: 200px; font-size: 13px; }
}
</style>
</head>
<body>

<!-- Toast Container -->
<div id="toast-container"></div>

<nav class="nav">
    <div class="nav-brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        Mebel Aliya
    </div>
    
    <!-- Global Search -->
    <div style="display:flex; gap:8px; background: #f8fafc; padding: 4px; border-radius: 12px; border: 1px solid var(--border);">
        <input type="text" id="global-search-input" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞..." style="width: 120px; margin:0; padding: 8px 12px; border:none; background:transparent;" onkeypress="if(event.key==='Enter') openGlobalSearch()">
        <button class="btn-blue" style="padding: 6px 12px; border-radius: 8px;" onclick="openGlobalSearch()">üîç</button>
    </div>

    <!-- Admin Nav -->
    <div class="nav-links" id="admin-nav">
        <button class="tab-btn active" onclick="showPage('page-dashboard')">–û–±–∑–æ—Ä</button>
        <button class="tab-btn" onclick="showPage('page-workers')">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>
        <button class="tab-btn" onclick="showPage('page-crm')">CRM</button>
        <button class="tab-btn" onclick="showPage('page-orders')">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
        <button class="tab-btn" onclick="showPage('page-monitor')">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
    </div>
    
    <div style="display: flex; gap: 10px;">
        <button class="btn-red hidden" id="logout-btn" onclick="handleLogout()">–í—ã–π—Ç–∏</button>
    </div>
</nav>

<!-- Search Modal -->
<div id="search-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeGlobalSearch()">
    <div class="modal-content">
        <h3 style="margin-top:0">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #<span id="modal-order-id" style="color:var(--primary)"></span></h3>
        <div id="modal-order-content" style="max-height: 400px; overflow-y: auto;"></div>
        <br>
        <button class="btn-ghost" style="width:100%" onclick="closeGlobalSearch()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div class="container">
    <!-- Login -->
    <div id="page-login" class="card" style="max-width: 400px; margin: 60px auto; text-align: center; border-top: 4px solid var(--primary);">
        <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <p style="color: #64748b; margin-bottom: 20px;">Login ismingizni yoki kodingizni kiriting va boshlang</p>
        <input type="text" id="login-input" placeholder="Login ismingiz" onkeypress="if(event.key==='Enter') handleLogin()">
        <button class="btn-blue" style="width: 100%; padding: 14px;" onclick="handleLogin()">Kirish</button>
    </div>

    <!-- WORKER TERMINAL (Smart Version) -->
    <div id="page-worker-terminal" class="hidden">
        <div class="card" style="background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); color: white; border: none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 id="worker-title" style="margin:0; font-size: 22px;">–†–∞–±–æ—Ç–Ω–∏–∫</h2>
                    <p style="opacity: 0.9; font-size: 14px; margin-top: 5px;">–í–∞—à–µ —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ</p>
                </div>
            </div>
        </div>

        <!-- Smart Tasks List (Available for this worker) -->
        <div class="card" id="worker-tasks-card">
            <h3 style="margin-top:0; display:flex; justify-content:space-between;">
                –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏
                <span class="proc-badge" id="task-count-badge">0</span>
            </h3>
            <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">–ó–∞–∫–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞—é—Ç –≤–∞—à–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤:</p>
            <div id="worker-tasks-list" class="task-list">
                <!-- Smart tasks injected here -->
            </div>
        </div>

        <div id="worker-action-card" class="card hidden">
            <div style="margin-bottom:20px;">
   		 <h3 id="active-proc-name" style="margin:0; color:var(--primary); text-align:center;">–ü—Ä–æ—Ü–µ—Å—Å: </h3>
	</div>
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px dashed var(--border); margin-bottom: 20px;">
                <label style="font-size: 12px; font-weight: 700; color: #64748b; display:block; margin-bottom:8px; text-transform:uppercase;">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="worker-order-input" placeholder="–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ" style="margin:0;">
                    <button class="btn-blue" onclick="workerFindOrder()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>

            <div id="worker-controls" class="hidden" style="text-align: center;">
                <button id="btn-start" class="btn-blue" style="width:100%; height: 70px; font-size: 20px; margin-bottom: 10px;" onclick="processAction('start')">‚ñ∂ –ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
                <button id="btn-finish" class="btn-green hidden" style="width:100%; height: 70px; font-size: 20px; margin-bottom: 10px;" onclick="processAction('finish')">‚úî –ó–ê–í–ï–†–®–ò–¢–¨</button>
                <div id="done-msg" style="background: #ecfdf5; color: #065f46; font-weight: 800; padding: 20px; border-radius: 12px; border: 1px solid #10b981;" class="hidden">–ì–û–¢–û–í–û</div>
            </div>
        </div>
    </div>

    <!-- Admin: Dashboard -->
    <div id="page-dashboard" class="page hidden">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                <div class="stat-val" style="color: var(--primary)" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
                <div class="stat-val" style="color: var(--warning)" id="stat-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
                <div class="stat-val" style="color: var(--success)" id="stat-finished">0</div>
            </div>
        </div>
        <div class="card">
            <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
            <div id="dashboard-activity-log" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Admin: Workers -->
    <div id="page-workers" class="page hidden">
        <div class="card" id="worker-form-container">
            <h3 id="worker-form-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
            <input type="text" id="adm-w-name" placeholder="–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" onkeypress="if(event.key==='Enter') saveWorker()">
            <div id="adm-w-grid" class="grid"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-blue" onclick="saveWorker()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-ghost hidden" id="btn-cancel-w" onclick="resetWorkerForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div class="card">
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–î–æ—Å—Ç—É–ø—ã</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="w-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin: CRM -->
    <div id="page-crm" class="page hidden">
        <div class="card">
            <h3>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <input type="text" id="crm-oid" placeholder="‚Ññ –ó–∞–∫–∞–∑–∞ (ID)">
                <input type="text" id="crm-client" placeholder="–ö–ª–∏–µ–Ω—Ç">
                <input type="text" id="crm-item" placeholder="–ò–∑–¥–µ–ª–∏–µ">
                <input type="number" id="crm-price" placeholder="–°—É–º–º–∞">
            </div>
            <button class="btn-blue" onclick="saveCRM()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
        <div class="card">
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—É–º–º–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="crm-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin: Production -->
<!-- Admin: Production -->
<div id="page-orders" class="page hidden">
    <div class="card">
        <h3>–ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h3>
        
        <!-- CRM LOOKUP BOX (New Feature) -->
        <div id="crm-lookup-card" class="card hidden" style="border-color: var(--primary); background: #f0fdf4; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:var(--primary)">üìã –î–∞–Ω–Ω—ã–µ –∏–∑ CRM</h4>
                <button class="btn-ghost" onclick="closeCRMLookup()" style="padding:4px 8px; font-size:12px;">‚úñ</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                <div><span style="color:#64748b;">–ö–ª–∏–µ–Ω—Ç:</span> <b id="lookup-client">-</b></div>
                <div><span style="color:#64748b;">–¢–æ–≤–∞—Ä:</span> <b id="lookup-item">-</b></div>
                <div><span style="color:#64748b;">–°—É–º–º–∞:</span> <b id="lookup-price">-</b></div>
                <div><span style="color:#64748b;">–î–∞—Ç–∞:</span> <b id="lookup-date">-</b></div>
            </div>
        </div>

        <div style="margin-bottom: 15px; padding: 12px; background: #fffbeb; border-radius: 8px; border: 1px solid #fcd34d; font-size: 13px; color: #92400e;">
            ‚ÑπÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –∏–∑ CRM –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞.
        </div>

        <input type="text" id="adm-o-id" placeholder="‚Ññ –∑–∞–∫–∞–∑–∞ (–∏–∑ CRM)" oninput="lookupCRMOrder(this.value)">
        <div id="adm-o-grid" class="grid"></div>
        <button class="btn-green" style="width: 100%; padding: 16px;" onclick="saveOrder()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ü–µ—Ö</button>
    </div>
</div>

    <!-- Admin: Monitor -->
    <div id="page-monitor" class="page hidden">
        <div class="card">
            <h3>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h3>
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>–ó–∞–∫–∞–∑</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–£–ø—Ä.</th></tr></thead>
                    <tbody id="m-table"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h3>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</h3>
            <div id="history-log" style="max-height: 300px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 12px; font-size: 13px;"></div>
        </div>
    </div>
</div>

<script>
// --- CONFIG ---
const SUPABASE_URL = 'https://xknypljgfgkzgokogexz.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_96Ews89Vjt4la_07SQhf6A_WOmDGSSN'; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PROCS = ["–†–∞—Å–∫—Ä–æ–π NESTING", "2 –ø–∏–ª—å–Ω—ã–π", "–∫—Ä–æ–º–∫–∞", "–ü—Ä–∏—Å–∞–¥–∫–∞", "–§–ê–°–ê–î NESTING", "–†–æ–≤–µ—Ä", "–§–∏–≥—É—Ä–Ω—ã–π –∫—Ä–æ–º–∫–∞", "–ü–ª–µ–Ω–∫–∞ PVC", "–∫—Ä–∞—Å–∫–∞", "OTK", "–£–ø–∞–∫–æ–≤–∫–∞", "–°–±–æ—Ä–∫–∞", "–£—Å—Ç–∞–Ω–æ–≤–∞–∫–∞"];

let workers = [], orders = [], crm_orders = [];
let curUser = null, curProc = null, editWId = null;

// --- UTILS: TOAST ---
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if(!container) return; // Safety
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = type === 'success' ? `<span>‚úî</span> ${message}` : `<span>‚úñ</span> ${message}`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

// --- DATA LOADING (FIXED) ---
async function loadAllData() {
    try {
        const [wRes, oRes, cRes] = await Promise.all([
            _supabase.from('workers').select('*'),
            _supabase.from('orders').select('*'),
            _supabase.from('crm_orders').select('*')
        ]);

        // 1. Fix WORKERS
        workers = (wRes.data || []).map(w => {
            let cleanProcs = [];
            try {
                if (typeof w.procs === 'string') cleanProcs = JSON.parse(w.procs);
                else if (Array.isArray(w.procs)) cleanProcs = w.procs;
            } catch (e) { console.warn(e); }
            return { ...w, procs: cleanProcs };
        });

        // 2. Fix ORDERS
        orders = (oRes.data || []).map(o => {
            let cleanPath = [];
            try {
                if (typeof o.path === 'string') cleanPath = JSON.parse(o.path);
                else if (Array.isArray(o.path)) cleanPath = o.path;
            } catch (e) { console.warn(e); }
            return { ...o, path: cleanPath };
        });

        crm_orders = cRes.data || [];
        
        // 3. Update Views
        renderDashboard(); renderWorkers(); renderMonitor(); renderCRM(); renderHistory();
        if(curUser) renderWorkerTasks();
        
    } catch (e) { 
        console.error("CRASH:", e); 
        showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", "error"); 
    }
}

// --- AUTH ---
// --- AUTH (FIXED: Saves & Loads Correct Page) ---
// --- AUTH (UPDATED: Mobile & Admin Password) ---
function handleLogin(forceLogin = false) {
    const input = document.getElementById('login-input');
    const val = input.value.trim();
    if(!val) return showToast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è", "error");
    
    // Hide tabs initially
    document.getElementById('admin-nav').style.display = 'none';
    document.getElementById('admin-nav').classList.remove('mobile-active');

    // 1. ADMIN PASSWORD CHECK (Updated to 'admin939291')
    if(val.toLowerCase() === 'admin939291') {
        curUser = { name: 'admin939291' }; // Set admin as user
        
        document.getElementById('page-login').classList.add('hidden');
        document.getElementById('admin-nav').style.display = 'flex';
        document.getElementById('admin-nav').classList.add('mobile-active');
        document.getElementById('logout-btn').classList.remove('hidden');
        showPage('page-dashboard');
        
        // SAVE SESSION
        localStorage.setItem('erp_user', 'admin');
        showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä");
    } else {
        // 2. WORKER LOGIC
        if(!forceLogin && workers.length === 0) {
            // Wait and try again if data isn't loaded yet
            setTimeout(() => handleLogin(true), 200);
            return;
        }

        const worker = workers.find(w => w.name.toLowerCase() === val.toLowerCase());
        if(worker) {
            curUser = worker;
            
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('admin-nav').style.display = 'none'; // Ensure admin tabs are hidden
            document.getElementById('page-worker-terminal').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('worker-title').innerText = worker.name;
            
            // SAVE SESSION
            localStorage.setItem('erp_user', worker.name);
            
            renderWorkerTasks();
            showToast(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${worker.name}`);
        } else {
            if(forceLogin) {
                 // Login failed (e.g., worker deleted). Clear session.
                 handleLogout();
            } else {
                showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "error");
            }
        }
    }
}

// --- WORKER LOGIC ---
function resetWorkerFlow() {
    curProc = null;
    document.getElementById('worker-action-card').classList.add('hidden');
    document.getElementById('worker-order-input').value = '';
    renderWorkerTasks();
}

function renderWorkerTasks() {
    const list = document.getElementById('worker-tasks-list');
    if(!list) return; list.innerHTML = '';
    
    let myProcs = curUser.procs || [];
    let myTasks = [];

    myProcs.forEach(proc => {
        orders.forEach(o => {
            if(o.path && o.path.includes(proc)) {
                const h = o.history && o.history[proc];
                if(!h || (!h.end && h.start)) {
                    myTasks.push({ order: o, proc: proc, status: h ? 'active' : 'pending' });
                }
            }
        });
    });

    const countBadge = document.getElementById('task-count-badge');
    if(countBadge) countBadge.innerText = myTasks.length;

    if(myTasks.length === 0) {
        list.innerHTML = '<div style="text-align:center; color: #94a3b8; padding: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
        return;
    }

    myTasks.forEach(task => {
        const el = document.createElement('div');
        el.className = 'task-item';
        const statusColor = task.status === 'active' ? 'background:#eef2ff; border-color:var(--primary)' : '';
        const statusText = task.status === 'active' ? '–í —Ä–∞–±–æ—Ç–µ' : '–û–∂–∏–¥–∞–µ—Ç';
        el.style.cssText = statusColor;
        el.innerHTML = `
            <div>
                <div style="font-weight:700; font-size:16px;">#${task.order.id}</div>
                <div style="font-size:12px; color:#64748b;">${task.proc}</div>
            </div>
            <div class="proc-badge ${task.status}">${statusText}</div>
        `;
        el.onclick = () => {
            selectWorkerProc(task.proc);
            document.getElementById('worker-order-input').value = task.order.id;
            workerFindOrder();
        };
        list.appendChild(el);
    });
}

// --- WORKER LOGIC: Smart Process Selection ---
function selectWorkerProc(p) {
    curProc = p;
    
    // 1. Update UI
    document.getElementById('active-proc-name').innerText = p;
    document.getElementById('worker-action-card').classList.remove('hidden');
    
    // 2. SMART SWITCH: If there is currently an order open in the input field, 
    // assume we want to switch to the new process immediately.
    const currentInput = document.getElementById('worker-order-input').value.trim();
    
    if(currentInput) {
        // We have an order ID. Let's try to check it for the NEW process.
        const o = orders.find(x => x.id === currentInput);
        
        if(o && o.path.includes(p)) {
            // Order found and fits new process! Start the flow immediately.
            document.getElementById('worker-controls').classList.remove('hidden');
            
            // Update buttons based on history for THIS new process
            const h = o.history && o.history[p];
            const isStarted = !!h;
            const isFinished = isStarted && !!h.end;

            document.getElementById('btn-start').classList.toggle('hidden', isStarted);
            document.getElementById('btn-finish').classList.toggle('hidden', !isStarted || isFinished);
            document.getElementById('done-msg').classList.toggle('hidden', !isFinished);
        } else {
            // Order doesn't match new process, or invalid. Clear controls.
            document.getElementById('worker-controls').classList.add('hidden');
            showToast(`–ó–∞–∫–∞–∑ #${currentInput} –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —ç—Ç–∞–ø "${p}"`, "error");
        }
    } else {
        // No order in input. Just clear controls and wait.
        document.getElementById('worker-controls').classList.add('hidden');
        document.getElementById('worker-order-input').value = '';
        document.getElementById('worker-order-input').focus();
    }
}

function workerFindOrder() {
    const oid = document.getElementById('worker-order-input').value.trim();
    const o = orders.find(x => x.id === oid);
    if(!o || !o.path.includes(curProc)) return showToast("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");

    document.getElementById('worker-controls').classList.remove('hidden');
    const h = o.history && o.history[curProc];
    const isStarted = !!h;
    const isFinished = isStarted && !!h.end;

    document.getElementById('btn-start').classList.toggle('hidden', isStarted);
    document.getElementById('btn-finish').classList.toggle('hidden', !isStarted || isFinished);
    document.getElementById('done-msg').classList.toggle('hidden', !isFinished);
}

async function processAction(type) {
    const oid = document.getElementById('worker-order-input').value.trim();
    const o = orders.find(x => x.id === oid);
    if(!o) return;

    if(!o.history) o.history = {};
    if(!o.history[curProc]) o.history[curProc] = {};

    try {
        const timestamp = new Date().toISOString();
        if(type === 'start') {
            if(o.history[curProc].start) return showToast("–£–∂–µ –Ω–∞—á–∞—Ç–æ", "error");
            o.history[curProc] = { start: timestamp, worker: curUser.name };
            await _supabase.from('logs').insert({ worker_name: curUser.name, order_id: oid, process_name: curProc, action_type: 'start' });
        } else {
            if(!o.history[curProc].start) return showToast("–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ", "error");
            if(o.history[curProc].end) return showToast("–£–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", "error");
            o.history[curProc].end = timestamp;
            await _supabase.from('logs').insert({ worker_name: curUser.name, order_id: oid, process_name: curProc, action_type: 'finish' });
        }
        const { error } = await _supabase.from('orders').upsert(o);
        if(error) throw error;
        await loadAllData();
        workerFindOrder();
        showToast(type === 'start' ? "–†–∞–±–æ—Ç–∞ –Ω–∞—á–∞—Ç–∞" : "–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    } catch (err) {
        showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
    }
}

// --- ADMIN LOGIC ---
function renderDashboard() {
    const total = orders.length;
    const active = orders.filter(o => !isOrderFinished(o)).length;
    const finished = orders.filter(o => {
        if(!isOrderFinished(o)) return false;
        const lastStep = o.path[o.path.length-1];
        const h = o.history[lastStep];
        return h && new Date(h.end).toDateString() === new Date().toDateString();
    }).length;

    document.getElementById('stat-total').innerText = total;
    document.getElementById('stat-active').innerText = active;
    document.getElementById('stat-finished').innerText = finished;
}

// --- ADMIN LOGIC: CRM LOOKUP ---
function lookupCRMOrder(orderId) {
    const inputVal = orderId.trim();
    const resultCard = document.getElementById('crm-lookup-card');
    
    // 1. Clear input if empty
    if(!inputVal) {
        resultCard.classList.add('hidden');
        return;
    }

    // 2. Search in CRM Data
    const orderData = crm_orders.find(c => c.oid === inputVal);

    if(orderData) {
        // 3. Fill Data and Show Card
        document.getElementById('lookup-client').innerText = orderData.client || '-';
        document.getElementById('lookup-item').innerText = orderData.item || '-';
        document.getElementById('lookup-price').innerText = (orderData.price || 0) + ' ‚Ç∏';
        document.getElementById('lookup-date').innerText = orderData.date || '–ù–µ—Ç –¥–∞—Ç—ã';
        
        resultCard.classList.remove('hidden');
    } else {
        // 4. Hide card if not found (or keep showing old? usually better to hide to avoid confusion)
        resultCard.classList.add('hidden');
    }
}

function closeCRMLookup() {
    document.getElementById('crm-lookup-card').classList.add('hidden');
    document.getElementById('adm-o-id').value = '';
}

function isOrderFinished(o) {
    if(!o.path || !o.history) return false;
    const lastStep = o.path[o.path.length-1];
    return !!o.history[lastStep]?.end;
}

async function saveWorker() {
    const name = document.getElementById('adm-w-name').value.trim();
    const procs = Array.from(document.querySelectorAll('#adm-w-grid input:checked')).map(c => c.value);
    if(!name) return showToast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è", "error");
    if(procs.length === 0) return showToast("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã", "error");

    try {
        const isRenaming = editWId && editWId !== name;
        if (isRenaming) {
            await _supabase.from('workers').delete().eq('name', editWId);
            await _supabase.from('workers').insert({ name, procs });
            showToast(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ '${name}'`);
        } else {
            await _supabase.from('workers').upsert({ name, procs });
            showToast("–î–æ—Å—Ç—É–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
        }
        resetWorkerForm();
        await loadAllData();
    } catch (err) {
        showToast("–û—à–∏–±–∫–∞: " + err.message, "error");
    }
}

function editWorker(name) {
    const w = workers.find(x => x.name === name);
    if(!w) return;
    editWId = name;
    document.getElementById('adm-w-name').value = w.name;
    document.getElementById('worker-form-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: " + name;
    document.getElementById('worker-form-container').classList.add('edit-mode-active');
    document.getElementById('btn-cancel-w').classList.remove('hidden');
    document.querySelectorAll('#adm-w-grid input').forEach(cb => {
        cb.checked = w.procs && w.procs.includes(cb.value);
    });
}

function resetWorkerForm() {
    editWId = null;
    document.getElementById('adm-w-name').value = '';
    document.getElementById('worker-form-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
    document.getElementById('worker-form-container').classList.remove('edit-mode-active');
    document.getElementById('btn-cancel-w').classList.add('hidden');
    document.querySelectorAll('#adm-w-grid input').forEach(cb => cb.checked = false);
}

function renderWorkers() {
    const tableBody = document.getElementById('w-table');
    if(!tableBody) return;
    tableBody.innerHTML = '';

    if(workers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</td></tr>';
        return;
    }

    tableBody.innerHTML = workers.map(w => {
        const procsList = Array.isArray(w.procs) ? w.procs : [];
        return `
        <tr>
            <td><b>${w.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</b></td>
            <td>${procsList.map(p => `<span class="proc-badge">${p}</span>`).join('')}</td>
            <td>
                <button class="btn-ghost" onclick="editWorker('${w.name}')">‚úèÔ∏è</button>
                <button class="btn-red" onclick="delW('${w.name}')">‚úñ</button>
            </td>
        </tr>`;
    }).join('');
}

function renderMonitor() {
    document.getElementById('m-table').innerHTML = orders.map(o => {
        // Calculate Percentage
        const totalSteps = (o.path || []).length;
        const finishedSteps = (o.path || []).filter(p => o.history?.[p]?.end).length;
        const progress = Math.round(finishedSteps / (totalSteps || 1) * 100);

        // Generate HTML for Process Names (Badges)
        // We iterate through the order's path and show status
        const procsHtml = (o.path || []).slice(0, 5).map(p => {
            const h = o.history && o.history[p];
            let cls = '';
            if(h && h.end) cls = 'finished';
            else if(h && h.start) cls = 'active';
            return `<span class="proc-badge ${cls}" style="font-size:10px;">${p}</span>`;
        }).join(' ');

        return `
        <tr>
            <td><b>#${o.id}</b></td>
            <td>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <!-- 1. Progress Bar -->
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="flex:1; min-width:100px; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
                            <div style="width:${progress}%; background:var(--primary); height:100%; transition: width 0.5s;"></div>
                        </div>
                        <span style="font-size:12px; font-weight:600;">${progress}%</span>
                    </div>
                    <!-- 2. Process Names -->
                    <div style="font-size:11px; color:#64748b; line-height:1.4;">
                        ${procsHtml}
                        ${totalSteps > 5 ? `<span style="color:#94a3b8;">... –∏ –µ—â–µ ${totalSteps - 5} —ç—Ç–∞–ø–æ–≤</span>` : ''}
                    </div>
                </div>
            </td>
            <td><button class="btn-red" onclick="delO('${o.id}')">‚úñ</button></td>
        </tr>`;
    }).join('');
}

async function renderHistory() {
    try {
        const { data: logs } = await _supabase.from('logs').select('*').order('created_at', {ascending: false}).limit(30);
        if(!logs) return;
        
        const html = logs.map(l => {
            // 1. Format Date/Time nicely
            const dateStr = new Date(l.created_at || Date.now()).toLocaleString('ru-RU', { 
                day: '2-digit', month: '2-digit', year: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            });

            // 2. Calculate Duration ONLY for 'finish' actions
            let timeStr = '';
            if(l.action_type === 'finish') {
                // Try to find matching 'start' log in this batch
                const startLog = logs.find(start => 
                    start.order_id === l.order_id && 
                    start.process_name === l.process_name && 
                    start.action_type === 'start'
                );

                if(startLog && startLog.created_at) {
                    const startTime = new Date(startLog.created_at).getTime();
                    const endTime = new Date(l.created_at).getTime();
                    const diffMs = endTime - startTime; // Difference in milliseconds
                    
                    // Convert to minutes and seconds
                    const minutes = Math.floor(diffMs / 60000);
                    const seconds = Math.floor((diffMs % 60000) / 1000);
                    
                    timeStr = `<span style="color:var(--primary); font-weight:600; font-size:11px; margin-left:5px;">
                        (${minutes}–º ${seconds}—Å)
                    </span>`;
                }
            }

            // 3. Style the row
            const isFinish = l.action_type === 'finish';
            const actionColor = isFinish ? 'var(--success)' : 'var(--primary)';
            const actionText = isFinish ? '–∑–∞–≤–µ—Ä—à–∏–ª' : '–Ω–∞—á–∞–ª';

            return `
            <div style="margin-bottom: 8px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; font-size: 13px; display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <span style="color:#94a3b8; font-size:11px;">${dateStr}</span><br>
                    <b>${l.worker_name}</b> 
                    <span style="color:${actionColor}; font-weight:600;">${actionText}</span> 
                    <b>${l.process_name}</b> –ø–æ –∑–∞–∫–∞–∑—É #${l.order_id}
                </div>
                ${timeStr}
            </div>`;
        }).join('');

        // Update both locations where history is shown
        const logContainer = document.getElementById('history-log');
        const dashContainer = document.getElementById('dashboard-activity-log');
        if(logContainer) logContainer.innerHTML = html;
        if(dashContainer) dashContainer.innerHTML = html;

    } catch (err) {
        console.error("History Error:", err);
    }
}

function renderCRM() {
    document.getElementById('crm-table-body').innerHTML = crm_orders.map(c => `
        <tr style="cursor:pointer;" onclick="copyToProduction('${c.oid}')">
            <td>#${c.oid}</td>
            <td>${c.client || '-'}</td>
            <td>${c.item || '-'}</td>
            <td>${c.price || 0}</td>
            <td>
                <button class="btn-red" onclick="event.stopPropagation(); delCRM('${c.oid}')">‚úñ</button>
            </td>
        </tr>`).join('');
}

// Helper: Click CRM row -> Copy ID to Production Tab
function copyToProduction(oid) {
    // 1. Switch Tab
    showPage('page-orders');
    
    // 2. Fill Input
    document.getElementById('adm-o-id').value = oid;
    
    // 3. Trigger Lookup Logic (This will show the client info)
    lookupCRMOrder(oid);
}

async function saveCRM() {
    const oid = document.getElementById('crm-oid').value.trim();
    if(!oid) return showToast("–í–≤–µ–¥–∏—Ç–µ ‚Ññ", "error");
    try {
        await _supabase.from('crm_orders').upsert({ 
            oid, 
            client: document.getElementById('crm-client').value, 
            item: document.getElementById('crm-item').value, 
            price: document.getElementById('crm-price').value 
        });
        ['crm-oid','crm-client','crm-item','crm-price'].forEach(id => document.getElementById(id).value = '');
        await loadAllData();
        showToast("–ó–∞–∫–∞–∑ –≤ CRM");
    } catch (err) { showToast("–û—à–∏–±–∫–∞", "error"); }
}

async function saveOrder() {
    const id = document.getElementById('adm-o-id').value.trim();
    const path = Array.from(document.querySelectorAll('#adm-o-grid input:checked')).map(cb => cb.value);
    if(!id) return showToast("–í–≤–µ–¥–∏—Ç–µ ‚Ññ", "error");
    try {
        const existing = orders.find(x => x.id === id);
        const payload = { id, path };
        if (!existing) payload.history = {};
        else payload.history = existing.history || {};
        
        await _supabase.from('orders').upsert(payload);
        document.getElementById('adm-o-id').value = '';
        document.querySelectorAll('#adm-o-grid input:checked').forEach(cb => cb.checked = false);
        await loadAllData();
        showToast("–ó–∞–∫–∞–∑ –∑–∞–ø—É—â–µ–Ω");
    } catch (err) { showToast("–û—à–∏–±–∫–∞", "error"); }
}

function delW(n) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { _supabase.from('workers').delete().eq('name', n).then(loadAllData); } }
function delO(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { _supabase.from('orders').delete().eq('id', id).then(loadAllData); } }
function delCRM(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { _supabase.from('crm_orders').delete().eq('oid', id).then(loadAllData); } }

function showPage(id) {
    document.querySelectorAll('.page, #page-worker-terminal, #page-login').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const target = document.getElementById(id);
    if(target) target.classList.remove('hidden');
}

function openGlobalSearch() {
    const query = document.getElementById('global-search-input').value.trim();
    if(!query) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä");
    const order = orders.find(o => o.id === query);
    if(!order) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω");
    
    document.getElementById('modal-order-id').innerText = order.id;
    const content = document.getElementById('modal-order-content');
    if(!order.path) { content.innerHTML = "–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞"; } 
    else {
        content.innerHTML = order.path.map(p => {
            const h = order.history && order.history[p];
            let st = '–û–∂–∏–¥–∞–µ—Ç', cls = '';
            if(h && h.end) { st='–ó–∞–≤–µ—Ä—à–µ–Ω'; cls='finished'; } 
            else if(h && h.start) { st='–í —Ä–∞–±–æ—Ç–µ'; cls='active'; }
            return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #f1f5f9; padding:5px 0;"><span>${p}</span><span class="proc-badge ${cls}">${st}</span></div>`;
        }).join('');
    }
    document.getElementById('search-modal').classList.remove('hidden');
}
function closeGlobalSearch() { document.getElementById('search-modal').classList.add('hidden'); }
function handleLogout() {
    // 1. Clear Memory
    localStorage.removeItem('erp_user');
    
    // 2. Reload Page
    // This will reset 'curUser', and show Login screen because no session is found
    location.reload();
}
function init() {
    // 1. Generate Grids
    const wg = document.getElementById('adm-w-grid');
    const og = document.getElementById('adm-o-grid');
    if(wg && og) {
        wg.innerHTML = ''; og.innerHTML = '';
        PROCS.forEach(p => {
            wg.innerHTML += `<label class="item-card"><input type="checkbox" value="${p}"> ${p}</label>`;
            og.innerHTML += `<label class="item-card"><input type="checkbox" value="${p}"> ${p}</label>`;
        });
    }

    // 2. Load Data (This populates 'workers' array)
    loadAllData().then(() => {
        // 3. CHECK SESSION (Runs only AFTER data is ready)
        const savedUser = localStorage.getItem('erp_user');
        if(savedUser) {
            // Found saved session! Auto-login.
            // Set input value so user sees who they are
            document.getElementById('login-input').value = savedUser;
            
            // Trigger Login Logic
            handleLogin(true); 
        }
    });
}
init();
</script>
</body>
</html>