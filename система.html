<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mebel ERP Elite - Smart System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>    
    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --border: #e2e8f0; --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 40px; }
        
        /* Navigation */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; padding-top: 90px; }
        .nav { background: #fff; padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        .nav-brand { font-weight: 800; font-size: 24px; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        
        .nav-links { display: none; gap: 8px; }
        .tab-btn { padding: 8px 16px; border: none; background: none; cursor: pointer; font-weight: 500; color: #64748b; border-radius: 8px; transition: all 0.2s; font-size: 14px; }
        .tab-btn.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .tab-btn:hover:not(.active) { background: #f8fafc; color: var(--text); }

        /* Components */
        .card { background: var(--card); padding: 24px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; box-shadow: var(--shadow); transition: transform 0.2s; }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .stat-val { font-size: 32px; font-weight: 800; color: var(--text); }
        .stat-label { font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Grids */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin: 16px 0; }
        .item-card { border: 1px solid var(--border); padding: 14px; border-radius: 12px; transition: 0.2s; background: #fff; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; }
        .item-card:hover { border-color: var(--primary); background: #eef2ff; transform: translateY(-2px); }
        .item-card input { margin: 0; width: auto; height: 16px; width: 16px; }

        /* Inputs & Buttons */
        input, select { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box; font-size: 15px; margin-bottom: 12px; transition: 0.2s; background: #fff; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        button { padding: 12px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        button:active { transform: scale(0.98); }
        
        .btn-blue { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-blue:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-green { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
        .btn-green:hover { filter: brightness(1.1); }
        .btn-red { background: var(--danger); color: white; }
        .btn-ghost { background: #f1f5f9; color: #64748b; }
        .btn-ghost:hover { background: #e2e8f0; color: var(--text); }

        /* Tables */
        .table-wrapper { overflow-x: auto; }
        .modern-table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        .modern-table th { background: #f8fafc; text-align: left; padding: 14px; border-bottom: 2px solid var(--border); color: #64748b; font-size: 12px; font-weight: 600; }
        .modern-table td { padding: 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        /* Badges */
        .proc-badge { display: inline-flex; align-items: center; padding: 4px 10px; margin: 2px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #f8fafc; border: 1px solid var(--border); }
        .proc-badge.finished { background: #ecfdf5; border-color: #10b981; color: #065f46; }
        .proc-badge.active { background: #eef2ff; border-color: #4f46e5; color: #3730a3; }

        /* Smart Task List */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .task-item:hover { border-color: var(--primary); background: #f8fafc; }
        .task-item.priority { border-left: 4px solid var(--warning); }

        /* State Machine Badges */
        .state-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .state-badge.pending { background: #fff3cd; color: #b45309; border: 1px solid #f59e0b; }
        .state-badge.active { background: #dcfce7; color: #064e3b; border: 1px solid #16a34a; }
        .state-badge.done { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }

        .duration-cell { color: #64748b; font-size: 12px; font-weight: 600; }

        /* Activity Log Colors */
        .activity-login { color: var(--success); font-weight: 600; }
        .activity-logout { color: var(--warning); font-weight: 600; }
        .activity-worker { color: var(--primary); font-weight: 600; }
        .activity-crm { color: #8b5cf6; font-weight: 600; }
        .activity-order { color: var(--success); font-weight: 600; }
        .activity-delete { color: var(--danger); font-weight: 600; }
        .activity-process { color: #0ea5e9; font-weight: 600; }
	
	/* KANBAN BOARD STYLES */
.kanban-board {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding: 20px 0;
    min-height: 600px;
}

.kanban-column {
    min-width: 280px;
    background: #f8fafc;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    max-height: 700px;
    border: 1px solid var(--border);
}

.kanban-column-header {
    padding: 12px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}

.kanban-column-content {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

.kanban-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid var(--border);
    cursor: move;
    transition: all 0.3s ease;
    position: relative;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--primary);
}

.kanban-card.pending {
    border-left: 4px solid #f59e0b;
}

.kanban-card.in-progress {
    border-left: 4px solid var(--primary);
}

.kanban-card.completed {
    border-left: 4px solid var(--success);
}

.kanban-card-id {
    font-weight: 800;
    font-size: 16px;
    color: var(--primary);
    margin-bottom: 5px;
}

.kanban-card-client {
    font-size: 13px;
    color: #64748b;
    margin-bottom: 3px;
}

.kanban-card-item {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
}

.kanban-card-date {
    font-size: 11px;
    color: #94a3b8;
    margin-bottom: 8px;
}

.kanban-card-progress {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
}

.kanban-progress-bar {
    flex: 1;
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.kanban-progress-fill {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s ease;
}

.kanban-progress-text {
    font-size: 11px;
    font-weight: 700;
    color: #64748b;
    white-space: nowrap;
}

.kanban-card-worker {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: #64748b;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed #e2e8f0;
}

.kanban-card-duration {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #f1f5f9;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    color: #64748b;
}

.kanban-empty-state {
    text-align: center;
    padding: 30px 20px;
    color: #94a3b8;
}

.kanban-empty-state i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
}

/* DRAG AND DROP */
.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(3deg);
}

.kanban-column.drag-over {
    background: #e0f2fe;
    border-color: #0ea5e9;
}

/* KANBAN FILTERS */
.kanban-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.kanban-filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
    padding: 8px 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
}

.kanban-search {
    flex: 1;
    max-width: 300px;
}

.kanban-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.kanban-stat {
    background: white;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid var(--border);
    min-width: 150px;
}

.kanban-stat-label {
    font-size: 12px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.kanban-stat-value {
    font-size: 24px;
    font-weight: 800;
}

/* MOBILE KANBAN */
@media (max-width: 768px) {
    .kanban-board {
        flex-direction: column;
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    .kanban-column {
        min-width: 100%;
        max-height: 400px;
    }
    
    .kanban-filters {
        flex-direction: column;
    }
    
    .kanban-search {
        max-width: 100%;
    }
}
/* TV MODE STYLES FOR 4K - –ö–û–ú–ü–ê–ö–¢–ù–´–ô –í–ê–†–ò–ê–ù–¢ 230px */
.tv-mode-4k {
    font-size: 14px !important;
    overflow-x: hidden !important;
}

.tv-mode-4k .container {
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100vw !important;
}

/* –ö–ê–ù–ë–ê–ù –î–û–°–ö–ê - –ü–û–õ–ù–ê–Ø –®–ò–†–ò–ù–ê –ë–ï–ó –û–¢–°–¢–£–ü–û–í */
.tv-mode-4k .kanban-board {
    display: flex;
    gap: 6px !important; /* –ï—â–µ –º–µ–Ω—å—à–µ –æ—Ç—Å—Ç—É–ø–æ–≤ */
    padding: 0 5px !important; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    margin: 0 !important;
    min-height: 85vh;
    width: 100vw !important;
    overflow-x: visible !important;
    box-sizing: border-box;
    justify-content: flex-start;
    align-items: stretch;
}

/* –ö–û–õ–û–ù–ö–ò –ü–†–û–¶–ï–°–°–û–í - –£–õ–¨–¢–†–ê–ö–û–ú–ü–ê–ö–¢–ù–´–ï 230px */
.tv-mode-4k .kanban-column {
    min-width: 230px !important;
    max-width: 230px !important;
    width: 230px !important;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 8px !important;
    flex-shrink: 0;
    margin: 0 !important;
    max-height: 85vh !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

/* –ó–ê–ì–û–õ–û–í–ö–ò –ö–û–õ–û–ù–û–ö - –°–£–ü–ï–† –ö–û–ú–ü–ê–ö–¢–ù–´–ï */
.tv-mode-4k .kanban-column-header {
    font-size: 12px !important;
    font-weight: 800 !important;
    padding: 8px 6px !important;
    border-radius: 4px !important;
    margin-bottom: 8px !important;
    min-height: 50px !important;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    line-height: 1.1 !important;
    word-break: break-word;
}

/* –¢–µ–∫—Å—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ */
.tv-mode-4k .kanban-column-header .process-name {
    font-size: 11px !important;
    line-height: 1.1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: 28px;
}

/* –°–ß–ï–¢–ß–ò–ö –í –ó–ê–ì–û–õ–û–í–ö–ï - –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ô */
.tv-mode-4k .kanban-column-header .column-count {
    background: rgba(255,255,255,0.3);
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 900;
    margin-top: 3px;
    min-width: 20px;
}

/* –ö–û–ù–¢–ï–ù–¢ –ö–û–õ–û–ù–ö–ò */
.tv-mode-4k .kanban-column-content {
    max-height: calc(85vh - 60px) !important;
    padding-right: 1px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 3px !important;
}

/* –ö–ê–†–¢–û–ß–ö–ò –ó–ê–ö–ê–ó–û–í - –£–õ–¨–¢–†–ê–ö–û–ú–ü–ê–ö–¢–ù–´–ï */
.tv-mode-4k .kanban-card {
    padding: 6px !important;
    margin-bottom: 3px !important;
    border-radius: 4px !important;
    border: 1px solid #e2e8f0 !important;
    min-height: 50px !important;
    max-height: 55px !important;
    overflow: hidden;
    font-size: 10px !important;
}

.tv-mode-4k .kanban-card:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
    border-color: var(--primary) !important;
}

/* ID –ó–ê–ö–ê–ó–ê */
.tv-mode-4k .kanban-card-id {
    font-size: 11px !important;
    font-weight: 900 !important;
    margin-bottom: 1px !important;
    color: var(--primary) !important;
    line-height: 1.1;
}

/* –ù–ê–ó–í–ê–ù–ò–ï –ò–ó–î–ï–õ–ò–Ø */
.tv-mode-4k .kanban-card-item {
    font-size: 10px !important;
    font-weight: 600 !important;
    margin-bottom: 1px !important;
    line-height: 1.1;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* –ö–õ–ò–ï–ù–¢ */
.tv-mode-4k .kanban-card-client {
    font-size: 9px !important;
    margin-bottom: 1px !important;
    color: #64748b !important;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* –°–ö–†–´–í–ê–ï–ú –ë–õ–û–ö –° –í–†–ï–ú–ï–ù–ï–ú –ù–ê–ß–ê–õ–ê/–ö–û–ù–¶–ê */
.tv-mode-4k .kanban-card > div:nth-child(5) {
    display: none !important;
}

/* –ë–õ–û–ö –° –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–Ø–ú–ò */
.tv-mode-4k .kanban-card > div:nth-child(6) {
    font-size: 8px !important;
    margin-bottom: 1px !important;
    padding: 0 !important;
    display: flex;
    justify-content: space-between;
}

/* –ü–†–û–ì–†–ï–°–° –ë–ê–† */
.tv-mode-4k .kanban-progress-bar {
    height: 3px !important;
    margin: 2px 0 !important;
    border-radius: 1px !important;
}

.tv-mode-4k .kanban-progress-text {
    font-size: 8px !important;
    font-weight: 700 !important;
    min-width: 25px;
}

/* –†–ê–ë–û–¢–ù–ò–ö */
.tv-mode-4k .kanban-card-worker {
    font-size: 8px !important;
    padding-top: 2px !important;
    margin-top: 2px !important;
    border-top: 1px dashed #e2e8f0 !important;
}

/* –î–õ–ò–¢–ï–õ–¨–ù–û–°–¢–¨ */
.tv-mode-4k .kanban-card-duration {
    font-size: 8px !important;
    padding: 1px 4px !important;
    border-radius: 6px !important;
    top: 3px !important;
    right: 3px !important;
}

/* –°–ö–†–´–í–ê–ï–ú –§–ò–õ–¨–¢–†–´ –ò –°–¢–ê–¢–ò–°–¢–ò–ö–£ */
.tv-mode-4k .kanban-filters,
.tv-mode-4k .kanban-stats {
    display: none !important;
}

/* –ó–ê–ì–û–õ–û–í–û–ß–ù–ê–Ø –ö–ê–†–¢–û–ß–ö–ê */
.tv-mode-4k #page-kanban .card:first-child {
    padding: 8px 12px !important;
    margin-bottom: 6px !important;
    border-radius: 6px !important;
}

.tv-mode-4k #page-kanban .card:first-child h2 {
    font-size: 16px !important;
    margin-bottom: 3px !important;
}

.tv-mode-4k #page-kanban .card:first-child p {
    font-size: 11px !important;
}

/* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
.tv-mode-4k .nav {
    padding: 6px 12px !important;
    min-height: 50px !important;
}

.tv-mode-4k .nav-brand {
    font-size: 16px !important;
}

.tv-mode-4k .container {
    padding-top: 60px !important;
}

/* –ö–ù–û–ü–ö–ê TV –†–ï–ñ–ò–ú–ê */
.tv-mode-4k .btn-blue {
    padding: 6px 10px !important;
    font-size: 11px !important;
    border-radius: 6px !important;
}

/* –†–ê–°–ß–ï–¢ –î–õ–Ø 12 –ö–û–õ–û–ù–û–ö:
   12 –∫–æ–ª–æ–Ω–æ–∫ √ó 230px = 2760px
   11 –æ—Ç—Å—Ç—É–ø–æ–≤ √ó 6px = 66px
   –ë–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã 5px √ó 2 = 10px
   –ò–¢–û–ì–û: 2760 + 66 + 10 = 2836px < 3840px (4K —ç–∫—Ä–∞–Ω) ‚úÖ */

/* –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï */
.tv-mode-4k .kanban-empty-state {
    padding: 10px !important;
    font-size: 10px !important;
}

.tv-mode-4k .kanban-empty-state i {
    font-size: 16px !important;
    margin-bottom: 3px !important;
}

/* –ê–ù–ò–ú–ê–¶–ò–ò */
.tv-mode-4k .kanban-card.in-progress {
    animation: pulse-4k 3s infinite !important;
    border-width: 1px !important;
}

@keyframes pulse-4k {
    0% { 
        box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); 
    }
    70% { 
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0); 
    }
    100% { 
        box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); 
    }
}

/* –£–ë–ò–†–ê–ï–ú –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–£–Æ –ü–†–û–ö–†–£–¢–ö–£ */
.tv-mode-4k body {
    overflow-x: hidden !important;
    width: 100vw !important;
}

/* –õ–ï–ì–ï–ù–î–ê –í–ù–ò–ó–£ */
.tv-mode-4k .card:last-child {
    padding: 8px !important;
    font-size: 10px !important;
    margin-top: 6px !important;
}

.tv-mode-4k .card:last-child > div {
    gap: 10px !important;
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –î–õ–Ø –†–ê–ó–ù–´–• –≠–ö–†–ê–ù–û–í */
@media (min-width: 3840px) {
    /* –î–ª—è 4K —ç–∫—Ä–∞–Ω–æ–≤ —É–∂–µ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ */
}

@media (max-width: 3839px) and (min-width: 2560px) {
    .tv-mode-4k .kanban-column {
        min-width: 210px !important;
        max-width: 210px !important;
        width: 210px !important;
    }
    /* 12 √ó 210px = 2520px, + –æ—Ç—Å—Ç—É–ø—ã = ~2600px < 2560px? –ù—É–∂–Ω–æ –µ—â–µ –º–µ–Ω—å—à–µ */
    .tv-mode-4k .kanban-board {
        gap: 4px !important;
    }
}

@media (max-width: 2559px) {
    .tv-mode-4k .kanban-column {
        min-width: 190px !important;
        max-width: 190px !important;
        width: 190px !important;
    }
    .tv-mode-4k .kanban-board {
        gap: 3px !important;
        padding: 0 2px !important;
    }
    .tv-mode-4k .kanban-card {
        padding: 4px !important;
        min-height: 45px !important;
        max-height: 48px !important;
    }
}

/* Hidden & Utilities */
.hidden { display: none !important; }
.edit-mode-active { border: 2px solid var(--warning) !important; background: #fffbeb !important; }

/* Toast Notifications */
#toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 5000; display: flex; flex-direction: column; gap: 10px; }
.toast { min-width: 250px; padding: 16px; background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; font-size: 14px; font-weight: 500; }
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Modal */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.modal-content { background: white; padding: 30px; border-radius: var(--radius); max-width: 500px; width: 100%; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* MOBILE OPTIMIZATIONS --- */
@media (max-width: 768px) {
    .grid { grid-template-columns: 1fr; } 
    .stats-grid { grid-template-columns: 1fr; }
    .nav { padding: 10px; }
    .nav-brand { font-size: 18px; }
    #admin-nav { 
        display: none;
        position: absolute; 
        top: 60px; 
        left: 0; 
        width: 100%; 
        background: white; 
        padding: 10px; 
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap; 
    }
    #admin-nav.mobile-active { display: flex; }
    .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .card { padding: 15px; }
    .toast { left: 20px; right: 20px; width: auto; min-width: 200px; font-size: 13px; }
}
    </style>
</head>
<body>
<!-- Toast Container -->
<div id="toast-container"></div>

<nav class="nav">
    <div class="nav-brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        Mebel Aliya
    </div>
    
    <!-- Global Search -->
    <div style="display:flex; gap:8px; background: #f8fafc; padding: 4px; border-radius: 12px; border: 1px solid var(--border);">
        <input type="text" id="global-search-input" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞..." style="width: 120px; margin:0; padding: 8px 12px; border:none; background:transparent;" onkeypress="if(event.key==='Enter') openGlobalSearch()">
        <button class="btn-blue" style="padding: 6px 12px; border-radius: 8px;" onclick="openGlobalSearch()">üîç</button>
    </div>

    <!-- Admin Nav -->
    <div class="nav-links" id="admin-nav">
        <button class="tab-btn active" onclick="showPage('page-dashboard')">–û–±–∑–æ—Ä</button>
        <button class="tab-btn" onclick="showPage('page-workers')">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>
        <button class="tab-btn" onclick="showPage('page-crm')">CRM</button>
        <button class="tab-btn" onclick="showPage('page-orders')">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
        <button class="tab-btn" onclick="showPage('page-monitor')">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
	<button class="tab-btn" onclick="showKanbanAsAdmin()">Kanban</button>
    </div>
    
    <div style="display: flex; gap: 10px;">
        <button class="btn-red hidden" id="logout-btn" onclick="handleLogout()">–í—ã–π—Ç–∏</button>
    </div>
</nav>

<!-- Search Modal -->
<div id="search-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeGlobalSearch()">
    <div class="modal-content">
        <h3 style="margin-top:0">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ #<span id="modal-order-id" style="color:var(--primary)"></span></h3>
        <div id="modal-order-content" style="max-height: 400px; overflow-y: auto;"></div>
        <br>
        <button class="btn-ghost" style="width:100%" onclick="closeGlobalSearch()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div class="container">
    <!-- Login -->
    <div id="page-login" class="card" style="max-width: 400px; margin: 60px auto; text-align: center; border-top: 4px solid var(--primary);">
        <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <p style="color: #64748b; margin-bottom: 20px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞</p>
        <input type="text" id="login-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" onkeypress="if(event.key==='Enter') handleLogin()">
        <button class="btn-blue" style="width: 100%; padding: 14px;" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- WORKER TERMINAL -->
    <div id="page-worker-terminal" class="hidden">
        <div class="card" style="background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); color: white; border: none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 id="worker-title" style="margin:0; font-size: 22px;">–†–∞–±–æ—Ç–Ω–∏–∫</h2>
                    <p style="opacity: 0.9; font-size: 14px; margin-top: 5px;">–í–∞—à–µ —Ä–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ</p>
                </div>
            </div>
        </div>

        <div class="card" id="worker-tasks-card">
            <h3 style="margin-top:0; display:flex; justify-content:space-between;">
                –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞—á–∏
                <span class="proc-badge" id="task-count-badge">0</span>
            </h3>
            <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">–ó–∞–∫–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞—é—Ç –≤–∞—à–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤:</p>
            <div id="worker-tasks-list" class="task-list"></div>
        </div>

        <div id="worker-action-card" class="card hidden">
            <div style="margin-bottom:20px;">
                <h3 id="active-proc-name" style="margin:0; color:var(--primary); text-align:center;">–ü—Ä–æ—Ü–µ—Å—Å: </h3>
            </div>
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px dashed var(--border); margin-bottom: 20px;">
                <label style="font-size: 12px; font-weight: 700; color: #64748b; display:block; margin-bottom: 8px; text-transform:uppercase;">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="worker-order-input" placeholder="–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ" style="margin:0;">
                    <button class="btn-blue" onclick="workerFindOrder()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>

            <div id="worker-controls" class="hidden" style="text-align: center;">
                <button id="btn-start" class="btn-blue" style="width:100%; height: 70px; font-size: 20px; margin-bottom: 10px;" onclick="processAction('start')">‚ñ∂ –ù–ê–ß–ê–¢–¨ –†–ê–ë–û–¢–£</button>
                <button id="btn-finish" class="btn-green hidden" style="width:100%; height: 70px; font-size: 20px; margin-bottom: 10px;" onclick="processAction('finish')">‚úî –ó–ê–í–ï–†–®–ò–¢–¨</button>
                <div id="done-msg" style="background: #ecfdf5; color: #065f46; font-weight: 800; padding: 20px; border-radius: 12px; border: 1px solid #10b981;" class="hidden">–ì–û–¢–û–í–û</div>
            </div>
        </div>
    </div>

    <!-- Admin: Dashboard -->
    <div id="page-dashboard" class="page hidden">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                <div class="stat-val" style="color: var(--primary)" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
                <div class="stat-val" style="color: var(--warning)" id="stat-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
                <div class="stat-val" style="color: var(--success)" id="stat-finished">0</div>
            </div>
        </div>
        <div class="card">
            <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
            <div id="dashboard-activity-log" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Admin: Workers -->
    <div id="page-workers" class="page hidden">
        <div class="card" id="worker-form-container">
            <h3 id="worker-form-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
            <input type="text" id="adm-w-name" placeholder="–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" onkeypress="if(event.key==='Enter') saveWorker()">
            <div id="adm-w-grid" class="grid"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-blue" onclick="saveWorker()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-ghost hidden" id="btn-cancel-w" onclick="resetWorkerForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div class="card">
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–î–æ—Å—Ç—É–ø—ã</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="w-table"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin: CRM -->
    <div id="page-crm" class="page hidden">
        <div class="card">
            <h3>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <input type="text" id="crm-oid" placeholder="‚Ññ –ó–∞–∫–∞–∑–∞ (ID)">
                <input type="text" id="crm-client" placeholder="–ö–ª–∏–µ–Ω—Ç">
                <input type="text" id="crm-item" placeholder="–ò–∑–¥–µ–ª–∏–µ">
                <input type="number" id="crm-price" placeholder="–°—É–º–º–∞">
            </div>
            <button class="btn-blue" onclick="saveCRM()">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
        <div class="card">
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead><tr><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—É–º–º–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                    <tbody id="crm-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin: Production -->
    <div id="page-orders" class="page hidden">
        <div class="card">
            <h3>–ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</h3>
        
        <div id="crm-lookup-card" class="card hidden" style="border-color: var(--primary); background: #f0fdf4; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0; color:var(--primary)">üìã –î–∞–Ω–Ω—ã–µ –∏–∑ CRM</h4>
                <button class="btn-ghost" onclick="closeCRMLookup()" style="padding: 4px 8px; font-size: 12px;">‚úñ</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                <div><span style="color:#64748b;">–ö–ª–∏–µ–Ω—Ç:</span> <b id="lookup-client">-</b></div>
                <div><span style="color:#64748b;">–¢–æ–≤–∞—Ä:</span> <b id="lookup-item">-</b></div>
                <div><span style="color:#64748b;">–°—É–º–º–∞:</span> <b id="lookup-price">-</b></div>
                <div><span style="color:#64748b;">–î–∞—Ç–∞:</span> <b id="lookup-date">-</b></div>
            </div>
        </div>

        <div style="margin-bottom: 15px; padding: 12px; background: #fffbeb; border-radius: 8px; border: 1px solid #fcd34d; font-size: 13px; color: #92400e;">
            ‚ÑπÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –∏–∑ CRM –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞.
        </div>

        <input type="text" id="adm-o-id" placeholder="‚Ññ –∑–∞–∫–∞–∑–∞ (–∏–∑ CRM)" oninput="lookupCRMOrder(this.value)">
        <div id="adm-o-grid" class="grid"></div>
        <button class="btn-green" style="width: 100%; padding: 16px;" onclick="saveOrder()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ü–µ—Ö</button>
    </div>
</div>

<!-- Admin: Monitor -->
<div id="page-monitor" class="page hidden">
    <div class="card">
        <h3>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h3>
        <div class="table-wrapper">
            <table class="modern-table">
                <thead><tr><th>–ó–∞–∫–∞–∑</th><th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th><th>–£–ø—Ä.</th></tr></thead>
                <tbody id="m-table"></tbody>
            </table>
        </div>
    </div>
    
    <!-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö –° –¢–ê–ë–õ–ò–¶–ï–ô –ü–†–û–¶–ï–°–°–û–í -->
    <div class="card">
        <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ –∑–∞–∫–∞–∑–∞–º</h3>
        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
            <input type="text" id="process-filter-order" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ ‚Ññ –∑–∞–∫–∞–∑–∞" 
                   style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px;"
                   oninput="renderProcessesTable()">
            <select id="process-filter-status" style="padding: 10px; border: 1px solid var(--border); border-radius: 8px;"
                    onchange="renderProcessesTable()">
                <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                <option value="in-progress">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="completed">–ó–∞–≤–µ—Ä—à—ë–Ω</option>
            </select>
            <button class="btn-ghost" onclick="resetProcessFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        
        <div class="table-wrapper">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>‚Ññ –ó–∞–∫–∞–∑–∞</th>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>–ü—Ä–æ—Ü–µ—Å—Å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ö—Ç–æ –Ω–∞—á–∞–ª</th>
                        <th>–ö—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª</th>
                        <th>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</th>
                        <th>–í—Ä–µ–º—è –∫–æ–Ω—Ü–∞</th>
                        <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                        <th>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–∫–∞–∑–∞</th>
                    </tr>
                </thead>
                <tbody id="processes-table">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #64748b;">
            <div>
                –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="process-count">0</span> –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
            </div>
            <div>
                <button class="btn-ghost" onclick="exportProcessesToCSV()" style="padding: 6px 12px; font-size: 12px;">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>
            </div>
        </div>
    </div>
	    <!-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö –ü–û–°–õ–ï –ü–ï–†–í–û–ô –ö–ê–†–¢–û–ß–ö–ò –ò –ü–ï–†–ï–î –í–¢–û–†–û–ô –ö–ê–†–¢–û–ß–ö–û–ô -->
<div class="card">
    <h3>–§–∏–ª—å—Ç—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
        <div>
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:5px;">–†–∞–±–æ—Ç–Ω–∏–∫</label>
            <input type="text" id="filter-user" placeholder="–ò–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
        </div>
        <div>
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:5px;">–¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è</label>
            <select id="filter-type" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
                <option value="all">–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è</option>
                <option value="login">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</option>
                <option value="logout">–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</option>
                <option value="process">–†–∞–±–æ—á–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</option>
            </select>
        </div>
        <div>
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:5px;">–î–∞—Ç–∞ —Å</label>
            <input type="date" id="filter-date-from" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
        </div>
        <div>
            <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:5px;">–î–∞—Ç–∞ –ø–æ</label>
            <input type="date" id="filter-date-to" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-blue" onclick="applyActivityFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        <button class="btn-ghost" onclick="resetActivityFilters()">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
</div>

        <div class="card">
            <h3>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
            <div class="table-wrapper">
    <table class="modern-table">
        <thead>
            <tr>
                <th>–í—Ä–µ–º—è</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                <th>–î–µ—Ç–∞–ª–∏</th>
                <th>–¢–∏–ø</th>
            </tr>
        </thead>
        <tbody id="history-log">
            <!-- Activity logs injected here -->
        </tbody>
    </table>
</div>
        </div>
    </div>
<!-- Kanban Board -->
<div id="page-kanban" class="page hidden">
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2 style="margin:0; font-size: 22px;">üè≠ Kanban –î–æ—Å–∫–∞</h2>
                <p style="opacity: 0.9; font-size: 14px; margin-top: 5px;">–í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <!-- –ö–Ω–æ–ø–∫–∞ TV —Ä–µ–∂–∏–º–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—Ä–µ —ç–∫—Ä–∞–Ω–∞ -->
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn-blue" onclick="toggleTVMode()" 
                            style="font-size: 16px; padding: 10px 20px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);"
                            title="Ctrl+Space –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è">
                        <span id="tv-mode-icon">üì∫</span>
                        <span id="tv-mode-text">TV –†–µ–∂–∏–º</span>
                    </button>
                    
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8);">
                        –≠–∫—Ä–∞–Ω: <span id="screen-size">${window.innerWidth}√ó${window.innerHeight}</span>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ Kanban -->
                <div id="kanban-stats" style="display: flex; gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                        <div style="font-size: 24px; font-weight: 800;" id="kanban-active-count">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">–í —Ä–∞–±–æ—Ç–µ</div>
                        <div style="font-size: 24px; font-weight: 800;" id="kanban-inprogress-count">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kanban Filters -->
    <div class="card">
        <div class="kanban-filters">
            <div class="kanban-filter-group" style="flex:1;">
                <svg width="18" height="18" fill="#64748b" viewBox="0 0 24 24"><path d="M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A7.952 7.952 0 0 0 18 10c0-4.411-3.589-8-8-8s-8 3.589-8 8 3.589 8 8 8zm0-14c3.309 0 6 2.691 6 6s-2.691 6-6 6-6-2.691-6-6 2.691-6 6-6z"></path></svg>
                <input type="text" id="kanban-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞..." class="kanban-search" style="border:none; padding:0; background:transparent; outline:none;">
            </div>
            <div class="kanban-filter-group">
                <label style="font-size:12px; color:#64748b;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                <select id="kanban-sort" style="border:none; background:transparent; outline:none; color:var(--text);">
                    <option value="date-desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                    <option value="date-asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                    <option value="priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</option>
                </select>
            </div>
            <div class="kanban-filter-group">
                <label style="font-size:12px; color:#64748b;">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                <select id="kanban-filter" style="border:none; background:transparent; outline:none; color:var(--text);">
                    <option value="all">–í—Å–µ –∑–∞–∫–∞–∑—ã</option>
                    <option value="active">–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="delayed">–° –∑–∞–¥–µ—Ä–∂–∫–æ–π</option>
                </select>
            </div>
            <button class="btn-blue" onclick="refreshKanban()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="kanban-board" id="kanban-board">
        <!-- Columns will be injected here by JavaScript -->
    </div>

    <!-- Legend -->
    <div class="card" style="margin-top: 20px; background: #f8fafc;">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; border-radius: 2px; background: #f59e0b;"></div>
                <span style="font-size: 12px; color: #64748b;">–û–∂–∏–¥–∞–µ—Ç –Ω–∞—á–∞–ª–∞</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; border-radius: 2px; background: var(--primary);"></div>
                <span style="font-size: 12px; color: #64748b;">–í —Ä–∞–±–æ—Ç–µ</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; border-radius: 2px; background: var(--success);"></div>
                <span style="font-size: 12px; color: #64748b;">–ó–∞–≤–µ—Ä—à—ë–Ω</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 12px; height: 12px; border-radius: 2px; background: var(--danger);"></div>
                <span style="font-size: 12px; color: #64748b;">–ó–∞–¥–µ—Ä–∂–∫–∞</span>
            </div>
            <div style="margin-left: auto; font-size: 11px; color: #94a3b8;">
                –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏
            </div>
        </div>
    </div>
</div>
</div>

<script>
// --- CONFIG ---
const SUPABASE_URL = 'https://xknypljgfgkzgokogexz.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_96Ews89Vjt4la_07SQhf6A_WOmDGSSN'; 
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PROCS = ["–†–∞—Å–∫—Ä–æ–π NESTING", "2 –ø–∏–ª—å–Ω—ã–π", "–∫—Ä–æ–º–∫–∞", "–ü—Ä–∏—Å–∞–¥–∫–∞", "–§–ê–°–ê–î NESTING", "–†–æ–≤–µ—Ä", "–§–∏–≥—É—Ä–Ω—ã–π –∫—Ä–æ–º–∫–∞", "–ü–ª–µ–Ω–∫–∞ PVC", "–∫—Ä–∞—Å–∫–∞", "OTK", "–£–ø–∞–∫–æ–≤–∫–∞", "–°–±–æ—Ä–∫–∞", "–£—Å—Ç–∞–Ω–æ–≤–∫–∞"];

// –ú–∞—Å—Å–∏–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è Kanban (–±–µ–∑ "–†–æ–≤–µ—Ä")
const KANBAN_PROCS = PROCS.filter(p => p !== "–†–æ–≤–µ—Ä");

let workers = [], orders = [], crm_orders = [];
let curUser = null, curProc = null, editWId = null;

// --- UTILS: TOAST ---
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if(!container) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = type === 'success' ? `<span>‚úî</span> ${message}` : `<span>‚úñ</span> ${message}`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

// --- LOG ACTIVITY FUNCTION ---
async function logActivity(userName, action, details = '', type = 'system') {
    try {
        // –ù–ï –ó–ê–ü–ò–°–´–í–ê–ï–ú –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (admin939291)
        if (userName === 'admin939291' || userName === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') {
            console.log(`[ADMIN ACTION SKIPPED] ${action}`, details);
            return;
        }
        
        // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        console.log(`[ACTIVITY] ${type.toUpperCase()}: ${userName} - ${action}`, details);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Supabase
        const { error } = await _supabase
            .from('activity_logs')
            .insert({
                user_name: userName,
                action: action,
                details: details,
                type: type
            });
            
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ Supabase:', error);
        } else {
            console.log('–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ª–æ–≥
        renderActivityLog();
        
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', err);
    }
}

// --- HELPER FUNCTIONS ---
function formatDuration(ms) {
    if (!ms || ms < 0) return '0–º';
    
    const totalSeconds = Math.floor(ms / 1000);
    const days = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    if (days > 0) {
        return `${days}–¥ ${hours}—á`;
    } else if (hours > 0) {
        return `${hours}—á ${minutes}–º`;
    } else if (minutes > 0) {
        return `${minutes}–º ${seconds}—Å`;
    } else {
        return `${seconds}—Å`;
    }
}

// –†–∞—Å—á–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
function calculateProcessDuration(history) {
    if (!history) return { duration: 0, formatted: '-', started: false, completed: false };
    
    const started = !!history.start;
    const completed = !!history.end;
    
    if (!started) {
        return { duration: 0, formatted: '-', started: false, completed: false };
    }
    
    const startTime = new Date(history.start);
    
    if (completed) {
        const endTime = new Date(history.end);
        const duration = endTime - startTime;
        return {
            duration: duration,
            formatted: formatDuration(duration),
            started: true,
            completed: true,
            startTime: startTime,
            endTime: endTime
        };
    } else {
        const now = new Date();
        const duration = now - startTime;
        return {
            duration: duration,
            formatted: formatDuration(duration),
            started: true,
            completed: false,
            startTime: startTime,
            endTime: null
        };
    }
}

// –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–∫–∞–∑–∞
function calculateOrderProgress(order) {
    if (!order || !order.path || order.path.length === 0) return 0;
    
    let completed = 0;
    for (const process of order.path) {
        const history = order.history?.[process];
        if (history && history.end) {
            completed++;
        }
    }
    
    return Math.round((completed / order.path.length) * 100);
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
function renderProcessesTable() {
    const tableBody = document.getElementById('processes-table');
    if (!tableBody) return;
    
    const orderFilter = document.getElementById('process-filter-order')?.value.trim().toLowerCase() || '';
    const statusFilter = document.getElementById('process-filter-status')?.value || 'all';
    
    let processCount = 0;
    let rowsHTML = '';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ –Ω–æ–º–µ—Ä—É (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    const sortedOrders = [...orders].sort((a, b) => {
        return b.id.localeCompare(a.id);
    });
    
    sortedOrders.forEach(order => {
        if (!order || !order.id) return;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞–∫–∞–∑–∞
        if (orderFilter && !order.id.toLowerCase().includes(orderFilter)) {
            return;
        }
        
        // –ù–∞—Ö–æ–¥–∏–º CRM –¥–∞–Ω–Ω—ã–µ
        const crmData = crm_orders.find(c => c && c.oid === order.id) || {};
        const orderProgress = calculateOrderProgress(order);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –º–∞—Ä—à—Ä—É—Ç–µ
        if (!order.path || !Array.isArray(order.path)) {
            return;
        }
        
        order.path.forEach((process, index) => {
            if (!process) return;
            
            const history = order.history?.[process];
            const durationInfo = calculateProcessDuration(history);
            const processNumber = index + 1;
            const totalProcesses = order.path.length;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞
            let status = 'pending';
            let statusText = '–û–∂–∏–¥–∞–µ—Ç';
            let statusClass = 'pending';
            
            if (durationInfo.started && !durationInfo.completed) {
                status = 'in-progress';
                statusText = '–í —Ä–∞–±–æ—Ç–µ';
                statusClass = 'active';
            } else if (durationInfo.completed) {
                status = 'completed';
                statusText = '–ó–∞–≤–µ—Ä—à—ë–Ω';
                statusClass = 'done';
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if (statusFilter !== 'all' && statusFilter !== status) {
                return;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
            const startTime = durationInfo.startTime ? 
                durationInfo.startTime.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
                
            const endTime = durationInfo.endTime ? 
                durationInfo.endTime.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
            rowsHTML += `
                <tr>
                    <td>
                        <div style="font-weight: 800; color: var(--primary);">#${order.id}</div>
                        <div style="font-size: 11px; color: #94a3b8;">${processNumber}/${totalProcesses}</div>
                    </td>
                    <td>
                        <div style="font-weight: 600;">${crmData.client || '-'}</div>
                        <div style="font-size: 12px; color: #64748b;">${crmData.item || '-'}</div>
                    </td>
                    <td>
                        <div style="font-weight: 600;">${process}</div>
                        <div style="font-size: 11px; color: #94a3b8; margin-top: 2px;">
                            ${processNumber} –∏–∑ ${totalProcesses}
                        </div>
                    </td>
                    <td>
                        <span class="state-badge ${statusClass}" style="font-size: 11px; padding: 4px 8px;">
                            ${statusText}
                        </span>
                    </td>
                    <td>${history?.worker || '-'}</td>
                    <td>${history?.completed_by || '-'}</td>
                    <td style="font-size: 12px; white-space: nowrap;">${startTime}</td>
                    <td style="font-size: 12px; white-space: nowrap;">${endTime}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="font-weight: 600; color: ${status === 'completed' ? 'var(--success)' : 'var(--primary)'}">
                                ${durationInfo.formatted || '-'}
                            </div>
                            ${status === 'in-progress' ? 
                                '<div class="blink" style="width: 8px; height: 8px; border-radius: 50%; background: var(--primary);"></div>' : 
                                ''}
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 60px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${orderProgress}%; height: 100%; background: var(--primary);"></div>
                            </div>
                            <span style="font-size: 12px; font-weight: 700;">${orderProgress}%</span>
                        </div>
                    </td>
                </tr>
            `;
            
            processCount++;
        });
    });
    
    if (processCount === 0) {
        rowsHTML = `
            <tr>
                <td colspan="10" style="text-align: center; padding: 40px; color: #94a3b8;">
                    <div style="font-size: 24px; margin-bottom: 10px;">üì≠</div>
                    <div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                    <div style="font-size: 12px; margin-top: 5px;">–ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑—ã</div>
                </td>
            </tr>
        `;
    }
    
    tableBody.innerHTML = rowsHTML;
    document.getElementById('process-count').textContent = processCount;
}

// –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
function resetProcessFilters() {
    document.getElementById('process-filter-order').value = '';
    document.getElementById('process-filter-status').value = 'all';
    renderProcessesTable();
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
function exportProcessesToCSV() {
    const headers = [
        '‚Ññ –ó–∞–∫–∞–∑–∞', '–ö–ª–∏–µ–Ω—Ç', '–ò–∑–¥–µ–ª–∏–µ', '–ü—Ä–æ—Ü–µ—Å—Å', '–ù–æ–º–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞', '–í—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤',
        '–°—Ç–∞—Ç—É—Å', '–ö—Ç–æ –Ω–∞—á–∞–ª', '–ö—Ç–æ –∑–∞–≤–µ—Ä—à–∏–ª', '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞', '–í—Ä–µ–º—è –∫–æ–Ω—Ü–∞', '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', '–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–∫–∞–∑–∞'
    ];
    
    let csvContent = headers.join(';') + '\n';
    
    orders.forEach(order => {
        const crmData = crm_orders.find(c => c && c.oid === order.id) || {};
        const orderProgress = calculateOrderProgress(order);
        
        if (!order.path || !Array.isArray(order.path)) return;
        
        order.path.forEach((process, index) => {
            const history = order.history?.[process];
            const durationInfo = calculateProcessDuration(history);
            
            let status = '–û–∂–∏–¥–∞–µ—Ç';
            if (durationInfo.started && !durationInfo.completed) {
                status = '–í —Ä–∞–±–æ—Ç–µ';
            } else if (durationInfo.completed) {
                status = '–ó–∞–≤–µ—Ä—à—ë–Ω';
            }
            
            const row = [
                order.id,
                crmData.client || '',
                crmData.item || '',
                process,
                index + 1,
                order.path.length,
                status,
                history?.worker || '',
                history?.completed_by || '',
                durationInfo.startTime ? durationInfo.startTime.toLocaleString('ru-RU') : '',
                durationInfo.endTime ? durationInfo.endTime.toLocaleString('ru-RU') : '',
                durationInfo.formatted || '0–º',
                `${orderProgress}%`
            ].map(cell => `"${cell}"`).join(';');
            
            csvContent += row + '\n';
        });
    });
    
    // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `–ø—Ä–æ—Ü–µ—Å—Å—ã_–∑–∞–∫–∞–∑–æ–≤_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV');
}

const style = document.createElement('style');
style.textContent = `
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    .blink {
        animation: blink 1s infinite;
    }
`;
document.head.appendChild(style);

function getOrderStatus(order, processName) {
    if (!order || !order.history) {
        return { 
            status: 'pending', 
            time: '-',
            text: '–û–∂–∏–¥–∞–µ—Ç'
        };
    }
    
    const history = order.history || {};
    const stepHistory = history[processName];
    
    if (stepHistory) {
        if (stepHistory.end) {
            const start = new Date(stepHistory.start);
            const end = new Date(stepHistory.end);
            const diff = end - start;
            return { 
                status: 'done', 
                time: formatDuration(diff),
                text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ'
            };
        } else if (stepHistory.start) {
            const start = new Date(stepHistory.start);
            const now = new Date();
            const diff = now - start;
            return { 
                status: 'active', 
                time: formatDuration(diff),
                text: '–í —Ä–∞–±–æ—Ç–µ'
            };
        }
    }
    return { 
        status: 'pending', 
        time: '-',
        text: '–û–∂–∏–¥–∞–µ—Ç'
    };
}
// --- DATA LOADING ---
async function loadAllData() {
    try {
        const [wRes, oRes, cRes] = await Promise.all([
            _supabase.from('workers').select('*'),
            _supabase.from('orders').select('*'),
            _supabase.from('crm_orders').select('*')
        ]);

        // 1. Fix WORKERS
        workers = (wRes.data || []).map(w => {
            let cleanProcs = [];
            try {
                if (typeof w.procs === 'string') cleanProcs = JSON.parse(w.procs);
                else if (Array.isArray(w.procs)) cleanProcs = w.procs;
            } catch (e) { console.warn(e); }
            return { ...w, procs: cleanProcs };
        });

        // 2. Fix ORDERS
        orders = (oRes.data || []).map(o => {
            let cleanPath = [];
            try {
                if (typeof o.path === 'string') cleanPath = JSON.parse(o.path);
                else if (Array.isArray(o.path)) cleanPath = o.path;
            } catch (e) { console.warn(e); }
            return { ...o, path: cleanPath };
        });

        crm_orders = cRes.data || [];
        
        // 3. Update Views
        renderDashboard(); renderWorkers(); renderMonitor(); renderCRM(); renderActivityLog(); renderProcessesTable();
        if(curUser && curUser.name !== 'admin939291' && curUser.name !== 'kanban') renderWorkerTasks();
        
    } catch (e) { 
        console.error("CRASH:", e); 
        showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö", "error"); 
    }
}

// --- ACTIVITY LOG RENDER ---
async function renderActivityLog(filters = {}) {
    try {
        let logs = [];
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase (–¢–û–õ–¨–ö–û —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤)
        try {
            let query = _supabase.from('activity_logs').select('*');
            
            // –ò—Å–∫–ª—é—á–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
            query = query.neq('user_name', 'admin939291');
            query = query.neq('user_name', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            if (filters.user_name && filters.user_name.trim() !== '') {
                query = query.ilike('user_name', `%${filters.user_name.trim()}%`);
            }
            if (filters.type && filters.type !== 'all') {
                query = query.eq('type', filters.type);
            }
            if (filters.date_from && filters.date_from.trim() !== '') {
                query = query.gte('created_at', `${filters.date_from}T00:00:00Z`);
            }
            if (filters.date_to && filters.date_to.trim() !== '') {
                query = query.lte('created_at', `${filters.date_to}T23:59:59Z`);
            }
            if (filters.action_text && filters.action_text.trim() !== '') {
                query = query.or(`action.ilike.%${filters.action_text}%,details.ilike.%${filters.action_text}%`);
            }
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ª–∏–º–∏—Ç
            const { data, error } = await query.order('created_at', { ascending: false }).limit(100);
            
            if (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏ –∏–∑ Supabase:', error);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∞–¥–º–∏–Ω–∞
                const localLogs = JSON.parse(localStorage.getItem('erp_activity_logs') || '[]');
                logs = localLogs.filter(log => 
                    log.user_name !== 'admin939291' && 
                    log.user_name !== '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
                );
            } else {
                logs = data || [];
            }
        } catch (err) {
            console.warn('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:', err);
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–¥–º–∏–Ω–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
            const localLogs = JSON.parse(localStorage.getItem('erp_activity_logs') || '[]');
            logs = localLogs.filter(log => 
                log.user_name !== 'admin939291' && 
                log.user_name !== '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
            );
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        if (!logs || logs.length === 0) {
            const container = document.getElementById('dashboard-activity-log');
            const historyContainer = document.getElementById('history-log');
            
            if (container) {
                container.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</div>';
            }
            if (historyContainer) {
                historyContainer.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</td></tr>';
            }
            return;
        }
        
        // –î–ª—è –¥–∞—à–±–æ—Ä–¥–∞ (–ø–µ—Ä–≤—ã–µ 10 –∑–∞–ø–∏—Å–µ–π)
        const dashboardContainer = document.getElementById('dashboard-activity-log');
        if (dashboardContainer) {
            const dashboardHtml = logs.slice(0, 10).map(l => {
                const dateStr = new Date(l.created_at).toLocaleString('ru-RU', { 
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
                });
                
                let actionClass = 'activity-system';
                if (l.type === 'login') actionClass = 'activity-login';
                else if (l.type === 'logout') actionClass = 'activity-logout';
                else if (l.type === 'process') actionClass = 'activity-process';
                
                return `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #f1f5f9;">
                    <div style="flex:1; display:flex; align-items:center; gap:10px;">
                        <div style="font-size:16px;">üë§</div>
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:14px; margin-bottom:2px;">${l.user_name}</div>
                            <div style="font-size:13px; color:#64748b;">${l.action}</div>
                            ${l.details ? `<div style="font-size:12px; color:#94a3b8; margin-top:2px;">${l.details}</div>` : ''}
                        </div>
                    </div>
                    <div style="font-size:12px; color:#94a3b8;">${dateStr}</div>
                </div>`;
            }).join('');
            
            dashboardContainer.innerHTML = dashboardHtml;
        }
        
        // –î–ª—è –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
        const historyContainer = document.getElementById('history-log');
        if (historyContainer) {
            const historyHtml = logs.map(l => {
                const dateStr = new Date(l.created_at).toLocaleString('ru-RU', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                
                let actionClass = 'activity-system';
                if (l.type === 'login') actionClass = 'activity-login';
                else if (l.type === 'logout') actionClass = 'activity-logout';
                else if (l.type === 'process') actionClass = 'activity-process';
                
                // –¶–≤–µ—Ç –¥–ª—è –±–µ–π–¥–∂–∞ —Ç–∏–ø–∞
                let badgeColor = 'background:#f8fafc; color:#64748b;';
                if (l.type === 'login') badgeColor = 'background:#dcfce7; color:#166534;';
                else if (l.type === 'logout') badgeColor = 'background:#fef3c7; color:#92400e;';
                else if (l.type === 'process') badgeColor = 'background:#e0f2fe; color:#0369a1;';
                
                return `
                <tr>
                    <td style="font-size:12px; color:#64748b; white-space:nowrap;">${dateStr}</td>
                    <td><b>${l.user_name}</b></td>
                    <td class="${actionClass}">${l.action}</td>
                    <td style="max-width:200px; word-wrap:break-word;">${l.details || '-'}</td>
                    <td><span class="proc-badge" style="${badgeColor}">${l.type}</span></td>
                </tr>`;
            }).join('');
            
            historyContainer.innerHTML = historyHtml;
        }
        
    } catch (err) {
        console.error("Activity Log Error:", err);
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
function applyActivityFilters() {
    const filters = {
        user_name: document.getElementById('filter-user')?.value.trim() || '',
        type: document.getElementById('filter-type')?.value || 'all',
        date_from: document.getElementById('filter-date-from')?.value || '',
        date_to: document.getElementById('filter-date-to')?.value || '',
        action_text: document.getElementById('filter-action')?.value.trim() || ''
    };
    
    renderActivityLog(filters);
}

function resetActivityFilters() {
    document.getElementById('filter-user').value = '';
    document.getElementById('filter-type').value = 'all';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    document.getElementById('filter-action').value = '';
    
    renderActivityLog();
}

// --- AUTH ---
async function handleLogin(forceLogin = false) {
    const input = document.getElementById('login-input');
    const val = input.value.trim();
    if(!val) return showToast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è", "error");
    
    // Hide tabs initially
    document.getElementById('admin-nav').style.display = 'none';
    document.getElementById('admin-nav').classList.remove('mobile-active');
    
    // 1. KANBAN LOGIN
    if(val.toLowerCase() === 'kanban') {
        curUser = { name: 'kanban' };
        
        document.getElementById('page-login').classList.add('hidden');
        document.getElementById('admin-nav').style.display = 'none';
        document.getElementById('page-kanban').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        
        localStorage.setItem('erp_user', 'kanban');
        localStorage.setItem('erp_user_type', 'kanban');
        
        await loadKanbanData();
        showToast("Kanban –¥–æ—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        return;
    }

    // 1. ADMIN PASSWORD CHECK
    if(val.toLowerCase() === 'admin939291') {
        curUser = { name: 'admin939291' };
        
        document.getElementById('page-login').classList.add('hidden');
        document.getElementById('admin-nav').style.display = 'flex';
        document.getElementById('admin-nav').classList.add('mobile-active');
        document.getElementById('logout-btn').classList.remove('hidden');
        showPage('page-dashboard');
        
        localStorage.setItem('erp_user', 'admin939291');
        localStorage.setItem('erp_user_type', 'admin');
        
        // –ù–ï –õ–û–ì–ò–†–£–ï–ú –≤—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        showToast("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä");
        return;
    } else {
        // 2. WORKER LOGIC
        if(!forceLogin && workers.length === 0) {
            setTimeout(() => handleLogin(true), 200);
            return;
        }

        const worker = workers.find(w => w.name.toLowerCase() === val.toLowerCase());
        if(worker) {
            curUser = worker;
            
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('admin-nav').style.display = 'none';
            document.getElementById('page-worker-terminal').classList.remove('hidden');
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('worker-title').innerText = worker.name;
            
            localStorage.setItem('erp_user', worker.name);
            localStorage.setItem('erp_user_type', 'worker');
            
            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
            await logActivity(worker.name, '–í–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É', '–†–∞–±–æ—á–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª', 'login');
            renderWorkerTasks();
            showToast(`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${worker.name}`);
        } else {
            if(forceLogin) {
                 handleLogout();
            } else {
                showToast("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å", "error");
            }
        }
    }
}
async function cleanupOldLogs(daysToKeep = 90) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ä—à–µ ${daysToKeep} –¥–Ω–µ–π?`)) return;
    
    try {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
        
        const { error } = await _supabase
            .from('activity_logs')
            .delete()
            .lt('created_at', cutoffDate.toISOString());
            
        if (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤:', error);
            showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤', 'error');
            return;
        }
        
        showToast(`–£–¥–∞–ª–µ–Ω—ã –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ ${daysToKeep} –¥–Ω–µ–π`);
        renderActivityLog();
        
        // –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —Ç–æ–∂–µ
        const localLogs = JSON.parse(localStorage.getItem('erp_activity_logs') || '[]');
        const filteredLogs = localLogs.filter(log => {
            const logDate = new Date(log.created_at || log.timestamp);
            return logDate > cutoffDate;
        });
        localStorage.setItem('erp_activity_logs', JSON.stringify(filteredLogs));
        
    } catch (err) {
        console.error('Cleanup error:', err);
        showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤', 'error');
    }
}

// --- KANBAN LOGIC ---
let kanbanOrders = [];
let isDragging = false;
let draggedCard = null;

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—Ä–µ —ç–∫—Ä–∞–Ω–∞
function updateScreenSize() {
    const screenSizeElement = document.getElementById('screen-size');
    if (screenSizeElement) {
        screenSizeElement.textContent = `${window.innerWidth}√ó${window.innerHeight}`;
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Kanban
async function loadKanbanData() {
    try {
        console.log('–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ Kanban –¥–∞–Ω–Ω—ã—Ö...');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
        const { data: ordersData, error: ordersError } = await _supabase
            .from('orders')
            .select('*');
        
        if (ordersError) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', ordersError);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤', 'error');
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º CRM –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        const { data: crmData, error: crmError } = await _supabase
            .from('crm_orders')
            .select('*');
        
        if (crmError) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CRM –¥–∞–Ω–Ω—ã—Ö:', crmError);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ CRM –¥–∞–Ω–Ω—ã—Ö
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        kanbanOrders = (ordersData || []).map(order => {
            // –ù–∞—Ö–æ–¥–∏–º CRM –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
            const crmInfo = (crmData || []).find(c => c && c.oid === order.id) || {};
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏ —Å—Ç–∞—Ç—É—Å
            const currentProcess = getCurrentProcess(order);
            
            return {
                ...order,
                crm_client: crmInfo.client || '–ù–µ —É–∫–∞–∑–∞–Ω',
                crm_item: crmInfo.item || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                crm_price: crmInfo.price || 0,
                current_process: currentProcess.process,
                current_status: currentProcess.status,
                progress: calculateProgress(order),
                days_in_process: calculateDaysInProcess(order, currentProcess.process)
            };
        })
        .filter(order => order && order.id) // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –∑–∞–∫–∞–∑—ã
        .filter(order => {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–∫–∞–∑—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å "–†–æ–≤–µ—Ä"
            if (order.current_process === "–†–æ–≤–µ—Ä") {
                console.log(`–ó–∞–∫–∞–∑ #${order.id} —Å–∫—Ä—ã—Ç –∏–∑ Kanban (–ø—Ä–æ—Ü–µ—Å—Å "–†–æ–≤–µ—Ä")`);
                return false;
            }
            return true;
        })
        .filter(order => order.progress < 100); // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
        
        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${kanbanOrders.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è Kanban (–±–µ–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ "–†–æ–≤–µ—Ä")`);
        
        renderKanban();
        updateKanbanStats();
        updateScreenSize();
        autoDetectTVMode();
    } catch (err) {
        console.error('Kanban data load error:', err);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Kanban –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è Kanban (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º "–†–æ–≤–µ—Ä")
function getCurrentProcess(order) {
    if (!order || !order.path || !Array.isArray(order.path) || order.path.length === 0) {
        return { process: '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω', status: 'pending' };
    }
    
    try {
        // –ò—â–µ–º –ø–µ—Ä–≤—ã–π –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –ø—Ä–æ–ø—É—Å–∫–∞—è "–†–æ–≤–µ—Ä"
        for (const process of order.path) {
            if (!process || process === "–†–æ–≤–µ—Ä") {
                continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º "–†–æ–≤–µ—Ä"
            }
            
            const history = order.history?.[process];
            
            if (!history || !history.start) {
                // –ü—Ä–æ—Ü–µ—Å—Å –µ—â–µ –Ω–µ –Ω–∞—á–∏–Ω–∞–ª—Å—è
                return { process, status: 'pending' };
            }
            
            if (history.start && !history.end) {
                // –ü—Ä–æ—Ü–µ—Å—Å –≤ —Ä–∞–±–æ—Ç–µ
                return { process, status: 'in-progress' };
            }
            
            if (history.start && history.end) {
                // –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π
                continue;
            }
        }
        
        // –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏–ª–∏ —Ç–æ–ª—å–∫–æ "–†–æ–≤–µ—Ä" –æ—Å—Ç–∞–ª—Å—è
        // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å (–Ω–µ "–†–æ–≤–µ—Ä")
        const lastProcess = order.path
            .filter(p => p !== "–†–æ–≤–µ—Ä")
            .slice(-1)[0];
            
        return { process: lastProcess || '–ó–∞–≤–µ—Ä—à–µ–Ω', status: 'completed' };
        
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞:', err);
        return { process: '–û—à–∏–±–∫–∞', status: 'pending' };
    }
}

// –†–∞—Å—á–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–∫–∞–∑–∞ (–∏–≥–Ω–æ—Ä–∏—Ä—É—è "–†–æ–≤–µ—Ä")
function calculateProgress(order) {
    if (!order || !order.path || order.path.length === 0) return 0;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º "–†–æ–≤–µ—Ä" –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    const filteredPath = order.path.filter(p => p !== "–†–æ–≤–µ—Ä");
    if (filteredPath.length === 0) return 100;
    
    let completed = 0;
    for (const process of filteredPath) {
        const history = order.history?.[process];
        if (history && history.end) {
            completed++;
        }
    }
    
    return Math.round((completed / filteredPath.length) * 100);
}

// –†–∞—Å—á–µ—Ç –¥–Ω–µ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
function calculateDaysInProcess(order, process) {
    const history = order.history?.[process];
    if (!history || !history.start) return 0;
    
    try {
        const startDate = new Date(history.start);
        if (isNaN(startDate.getTime())) return 0;
        
        const now = new Date();
        const diffTime = Math.abs(now - startDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays;
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –¥–Ω–µ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ:', err);
        return 0;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Kanban —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ç–µ–∫—Å—Ç–∞
function renderKanban() {
    console.log('=== –ù–ê–ß–ê–õ–û RENDER KANBAN ===');
    
    const board = document.getElementById('kanban-board');
    if (!board) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç kanban-board –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }
    
    try {
        board.innerHTML = '';
        
        if (!kanbanOrders || kanbanOrders.length === 0) {
            board.innerHTML = `
                <div style="text-align: center; padding: 60px; color: #94a3b8; width: 100%;">
                    <div style="font-size: 80px; margin-bottom: 30px;">üì≠</div>
                    <h3 style="font-size: 24px; margin-bottom: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h3>
                    <p style="font-size: 16px;">–í—Å–µ –∑–∞–∫–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏–ª–∏ –æ–∂–∏–¥–∞—é—Ç –∑–∞–ø—É—Å–∫–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</p>
                    <button class="btn-blue" onclick="location.reload()" style="font-size: 16px; padding: 15px 30px; margin-top: 30px;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            `;
            return;
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        const screenWidth = window.innerWidth;
        const processCount = KANBAN_PROCS.length;
        
        // –í TV —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É 230px –¥–ª—è 12 –∫–æ–ª–æ–Ω–æ–∫
        // –†–∞—Å—á–µ—Ç: 12 √ó 230px = 2760px + 11 –æ—Ç—Å—Ç—É–ø–æ–≤ √ó 6px = 66px = 2826px < 3840px
        let columnWidth = 230;
        let columnGap = 6;
        
        if (!isTVMode()) {
            // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞
            if (screenWidth >= 3840) {
                columnWidth = 240;
                columnGap = 10;
            } else if (screenWidth >= 2560) {
                columnWidth = 220;
                columnGap = 10;
            } else if (screenWidth >= 1920) {
                columnWidth = 200;
                columnGap = 8;
            } else {
                columnWidth = 180;
                columnGap = 6;
            }
        }
        
        // –°–æ–∑–¥–∞–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
        KANBAN_PROCS.forEach(process => {
            if (!process) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
            const processOrders = kanbanOrders.filter(order => 
                order && order.current_process === process
            );
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ —Å—Ç–∞—Ç—É—Å –∫–æ–ª–æ–Ω–∫–∏
            let headerColor = '#64748b';
            let statusText = '–û–∂–∏–¥–∞–µ—Ç';
            let borderStyle = '1px solid #e2e8f0';
            
            const hasInProgress = processOrders.some(o => o.current_status === 'in-progress');
            const hasCompleted = processOrders.some(o => o.current_status === 'completed');
            const hasDelayed = processOrders.some(o => {
                const processData = o.history?.[o.current_process];
                if (!processData || !processData.start || processData.end) return false;
                try {
                    const startTime = new Date(processData.start);
                    if (isNaN(startTime.getTime())) return false;
                    const now = new Date();
                    return (now - startTime) > (3 * 24 * 60 * 60 * 1000);
                } catch (err) {
                    return false;
                }
            });
            
            if (hasDelayed) {
                headerColor = '#ef4444';
                statusText = '–ó–∞–¥–µ—Ä–∂–∫–∞';
                borderStyle = '2px solid #ef4444';
            } else if (hasInProgress) {
                headerColor = '#4f46e5';
                statusText = '–í —Ä–∞–±–æ—Ç–µ';
                borderStyle = '2px solid #4f46e5';
            } else if (hasCompleted) {
                headerColor = '#10b981';
                statusText = '–ó–∞–≤–µ—Ä—à—ë–Ω';
                borderStyle = '2px solid #10b981';
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–ª–æ–Ω–∫—É
            const column = document.createElement('div');
            column.className = 'kanban-column';
            column.dataset.process = process;
            
            // –í TV —Ä–µ–∂–∏–º–µ –Ω–µ –∑–∞–¥–∞–µ–º —à–∏—Ä–∏–Ω—É —á–µ—Ä–µ–∑ style, –æ–Ω–∞ –∑–∞–¥–∞–Ω–∞ –≤ CSS
            if (!isTVMode()) {
                column.style.minWidth = columnWidth + 'px';
                column.style.maxWidth = columnWidth + 'px';
            }
            
            column.style.border = borderStyle;
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã
            const sortedOrders = [...processOrders].sort((a, b) => {
                const aDelayed = isOrderDelayed(a);
                const bDelayed = isOrderDelayed(b);
                if (aDelayed && !bDelayed) return -1;
                if (!aDelayed && bDelayed) return 1;
                return new Date(b.created_at || 0) - new Date(a.created_at || 0);
            });
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
            const processName = process;
            
            column.innerHTML = `
                <div class="kanban-column-header" style="background: ${headerColor}; border: ${borderStyle};">
                    <div style="text-align: center; width: 100%;">
                        <div class="process-name" style="
                            font-weight: 900; 
                            font-size: ${isTVMode() ? '11px' : '14px'}; 
                            margin-bottom: 3px;
                            line-height: 1.1;
                            word-break: break-word;
                            white-space: normal;
                            display: -webkit-box;
                            -webkit-line-clamp: 2;
                            -webkit-box-orient: vertical;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            min-height: ${isTVMode() ? '28px' : '35px'};
                            align-items: center;
                            justify-content: center;
                        ">
                            ${processName}
                        </div>
                        <div style="font-size: ${isTVMode() ? '9px' : '11px'}; opacity: 0.9; margin-top: 2px;">
                            ${statusText}
                        </div>
                    </div>
                    <span class="column-count" style="
                        background: rgba(255,255,255,0.3); 
                        padding: ${isTVMode() ? '2px 6px' : '4px 8px'}; 
                        border-radius: ${isTVMode() ? '10px' : '12px'}; 
                        font-size: ${isTVMode() ? '10px' : '12px'}; 
                        font-weight: 900; 
                        min-width: ${isTVMode() ? '20px' : '30px'}; 
                        text-align: center;
                        margin-top: ${isTVMode() ? '3px' : '5px'};
                    ">
                        ${processOrders.length}
                    </span>
                </div>
                <div class="kanban-column-content">
                    ${sortedOrders.length === 0 ? `
                        <div class="kanban-empty-state" style="font-size: ${isTVMode() ? '10px' : '12px'};">
                            <div style="font-size: ${isTVMode() ? '16px' : '20px'}; opacity: 0.3;">üì≠</div>
                            <div style="margin-top: 8px; color: #94a3b8;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>
                        </div>
                    ` : sortedOrders.map(order => createKanbanCard(order)).join('')}
                </div>
            `;
            
            board.appendChild(column);
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏
        if (!isTVMode()) {
            board.style.gap = columnGap + 'px';
        }
        
        updateKanbanStats();
        
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ Kanban:', err);
        board.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Kanban –¥–æ—Å–∫–∏</h3>
                <p>${err.message}</p>
                <button class="btn-blue" onclick="loadKanbanData()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
        `;
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞–∫–∞–∑–∞
function isOrderDelayed(order) {
    if (!order || !order.history || !order.history[order.current_process]) return false;
    
    const processData = order.history[order.current_process];
    if (!processData.start || processData.end) return false;
    
    try {
        const startTime = new Date(processData.start);
        if (isNaN(startTime.getTime())) return false;
        const now = new Date();
        return (now - startTime) > (3 * 24 * 60 * 60 * 1000);
    } catch (err) {
        return false;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è TV —Ä–µ–∂–∏–º–∞
function autoDetectTVMode() {
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;
    const savedMode = localStorage.getItem('erp_tv_mode');
    
    console.log(`–†–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞: ${screenWidth}√ó${screenHeight}, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: ${savedMode}`);
    
    // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω 4K (3840x2160) –∏–ª–∏ –±–ª–∏–∑–∫–æ, –∏ —Ä–µ–∂–∏–º –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω
    if (screenWidth >= 3500 && savedMode !== '4k') {
        enableTV4KMode();
        showToast(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–µ–Ω 4K —Ä–µ–∂–∏–º –¥–ª—è —ç–∫—Ä–∞–Ω–∞ ${screenWidth}√ó${screenHeight}`);
    }
    // –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –º–∞–ª–µ–Ω—å–∫–∏–π, –∞ —Ä–µ–∂–∏–º 4K –≤–∫–ª—é—á–µ–Ω - –æ—Ç–∫–ª—é—á–∞–µ–º
    else if (screenWidth < 2500 && savedMode === '4k') {
        disableTVMode();
        showToast(`TV —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω (–º–∞–ª–µ–Ω—å–∫–∏–π —ç–∫—Ä–∞–Ω ${screenWidth}√ó${screenHeight})`);
    }
    
    updateScreenSize();
}

// –í–∫–ª—é—á–µ–Ω–∏–µ TV 4K —Ä–µ–∂–∏–º–∞
function enableTV4KMode() {
    document.body.classList.add('tv-mode-4k');
    const board = document.getElementById('kanban-board');
    if (board) board.classList.add('tv-mode-4k');
    
    const tvIcon = document.getElementById('tv-mode-icon');
    const tvText = document.getElementById('tv-mode-text');
    if (tvIcon) tvIcon.textContent = 'üì∫';
    if (tvText) tvText.textContent = 'TV –í–ö–õ';
    
    localStorage.setItem('erp_tv_mode', '4k');
    console.log('TV 4K —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω');
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º Kanban –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π
    setTimeout(() => {
        renderKanban();
    }, 100);
}

// –í—ã–∫–ª—é—á–µ–Ω–∏–µ TV —Ä–µ–∂–∏–º–∞
function disableTVMode() {
    document.body.classList.remove('tv-mode-4k');
    const board = document.getElementById('kanban-board');
    if (board) board.classList.remove('tv-mode-4k');
    
    const tvIcon = document.getElementById('tv-mode-icon');
    const tvText = document.getElementById('tv-mode-text');
    if (tvIcon) tvIcon.textContent = 'üì∫';
    if (tvText) tvText.textContent = 'TV –†–µ–∂–∏–º';
    
    localStorage.removeItem('erp_tv_mode');
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º Kanban –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π
    setTimeout(() => {
        renderKanban();
    }, 100);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ TV —Ä–µ–∂–∏–º–∞
function isTVMode() {
    return document.body.classList.contains('tv-mode-4k');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ TV —Ä–µ–∂–∏–º–∞
function toggleTVMode() {
    if (isTVMode()) {
        disableTVMode();
        showToast('TV —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω');
    } else {
        enableTV4KMode();
        showToast('TV 4K —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ Kanban
function createKanbanCard(order) {
    if (!order || !order.id) {
        console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–∫–∞–∑ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ Kanban:', order);
        return '';
    }
    
    try {
        const currentProcess = getCurrentProcess(order);
        const crmInfo = crm_orders.find(c => c && c.oid === order.id) || {};
        const processDuration = calculateProcessDuration(order.history?.[order.current_process]);
        const totalDuration = calculateOrderTotalTime(order);
        
        const isDelayed = isOrderDelayed(order);
        const cardClass = `kanban-card ${currentProcess?.status || 'pending'} ${isDelayed ? 'delayed' : ''}`;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ TV —Ä–µ–∂–∏–º–µ –ª–∏ –º—ã
        const tvMode = isTVMode();
        
        // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è TV —Ä–µ–∂–∏–º–∞
        const fontSizeId = tvMode ? '11px' : '14px';
        const fontSizeItem = tvMode ? '10px' : '13px';
        const fontSizeClient = tvMode ? '9px' : '12px';
        const fontSizeTime = tvMode ? '8px' : '11px';
        const paddingCard = tvMode ? '6px' : '10px';
        const progressHeight = tvMode ? '3px' : '5px';
        
        return `
            <div class="${cardClass}" 
                 data-order-id="${order.id}"
                 draggable="true"
                 ondragstart="startDrag(event)"
                 ondragend="endDrag(event)"
                 style="padding: ${paddingCard} !important;">
                
                ${isDelayed ? `
                    <div class="kanban-card-duration" style="
                        background:#fee2e2; 
                        color:#991b1b; 
                        font-size: ${tvMode ? '8px' : '10px'}; 
                        font-weight: 900;
                        padding: ${tvMode ? '1px 4px' : '3px 6px'};
                    ">
                        ‚ö†Ô∏è +${Math.floor(processDuration.duration / (24 * 60 * 60 * 1000))}–¥
                    </div>
                ` : ''}
                
                <div class="kanban-card-id" style="font-size: ${fontSizeId};">
                    #${order.id}
                </div>
                
                <div class="kanban-card-item" style="
                    font-size: ${fontSizeItem}; 
                    font-weight: 600;
                    line-height: 1.1;
                    margin-bottom: 2px;
                    word-break: break-word;
                ">
                    ${crmInfo.item || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                </div>
                
                ${tvMode ? '' : `
                    <div class="kanban-card-client" style="
                        font-size: ${fontSizeClient};
                        margin-bottom: 4px;
                        color: #475569;
                        word-break: break-word;
                    ">
                        üë§ ${crmInfo.client || '–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞'}
                    </div>
                `}
                
                ${tvMode ? '' : `
                <div style="
                    margin: 6px 0; 
                    padding: 6px; 
                    background: #f8fafc; 
                    border-radius: 6px; 
                    font-size: ${fontSizeTime}; 
                    color: #64748b;
                ">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                        <span>–ù–∞—á–∞–ª–æ:</span>
                        <span style="font-weight: 600;">${processDuration.startTime ? processDuration.startTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '-'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>–ö–æ–Ω–µ—Ü:</span>
                        <span style="font-weight: 600;">${processDuration.endTime ? processDuration.endTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '-'}</span>
                    </div>
                </div>
                `}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <div style="font-size: ${fontSizeTime}; font-weight: 600; color: ${currentProcess?.status === 'in-progress' ? '#4f46e5' : '#64748b'};">
                        ${currentProcess?.status === 'in-progress' ? 'üîÑ' : '‚è≥'} ${processDuration.formatted || '0–º'}
                    </div>
                    <div style="font-size: ${fontSizeTime}; font-weight: 600; color: #64748b;">
                        ‚è±Ô∏è –í—Å–µ–≥–æ: ${totalDuration.formatted || '0–º'}
                    </div>
                </div>
                
                <div class="kanban-card-progress">
                    <div class="kanban-progress-bar" style="height: ${progressHeight} !important;">
                        <div class="kanban-progress-fill" style="width: ${order.progress || 0}%"></div>
                    </div>
                    <div class="kanban-progress-text" style="font-size: ${fontSizeTime};">
                        ${order.progress || 0}%
                    </div>
                </div>
                
                ${order.history?.[order.current_process]?.worker ? `
                    <div class="kanban-card-worker" style="
                        font-size: ${tvMode ? '8px' : '10px'};
                        padding-top: 4px;
                        margin-top: 4px;
                        border-top: 1px dashed #e2e8f0;
                        word-break: break-word;
                    ">
                        üë∑ ${order.history[order.current_process].worker}
                    </div>
                ` : ''}
            </div>
        `;
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Kanban –∫–∞—Ä—Ç–æ—á–∫–∏:', err);
        return '<div class="kanban-card error">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>';
    }
}
// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫–∞–∑–∞
function calculateOrderTotalTime(order) {
    if (!order || !order.history || Object.keys(order.history).length === 0) {
        return { total: 0, formatted: '0–º' };
    }
    
    try {
        let totalTime = 0;
        
        // –°—É–º–º–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤—Å–µ—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        for (const [process, data] of Object.entries(order.history)) {
            if (data && data.start && data.end) {
                const start = new Date(data.start);
                const end = new Date(data.end);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç
                if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                    totalTime += (end - start);
                }
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
        const currentProcess = getCurrentProcess(order);
        if (currentProcess.status === 'in-progress' && order.history[currentProcess.process]) {
            const startTime = new Date(order.history[currentProcess.process].start);
            if (!isNaN(startTime.getTime())) {
                const now = new Date();
                totalTime += (now - startTime);
            }
        }
        
        return {
            total: totalTime,
            formatted: formatTime(totalTime)
        };
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:', err);
        return { total: 0, formatted: '0–º' };
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞
function formatTime(ms) {
    if (!ms || ms < 0) return '0–º';
    
    const totalSeconds = Math.floor(ms / 1000);
    const days = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}–¥ ${hours}—á`;
    } else if (hours > 0) {
        return `${hours}—á ${minutes}–º`;
    } else if (minutes > 0) {
        return `${minutes}–º`;
    } else {
        return '< 1–º';
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateKanbanStats() {
    const activeCount = kanbanOrders.length;
    const inProgressCount = kanbanOrders.filter(o => o.current_status === 'in-progress').length;
    const delayedCount = kanbanOrders.filter(o => o.days_in_process > 3).length;
    
    document.getElementById('kanban-active-count').textContent = activeCount;
    document.getElementById('kanban-inprogress-count').textContent = inProgressCount;
}

// Drag and Drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
function startDrag(event) {
    isDragging = true;
    draggedCard = event.target;
    draggedCard.classList.add('dragging');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    event.dataTransfer.setData('text/plain', event.target.dataset.orderId);
    event.dataTransfer.effectAllowed = 'move';
}

function endDrag(event) {
    isDragging = false;
    if (draggedCard) {
        draggedCard.classList.remove('dragging');
    }
    draggedCard = null;
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã drag-over —Å–æ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
    document.querySelectorAll('.kanban-column').forEach(col => {
        col.classList.remove('drag-over');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ Kanban –∞–¥–º–∏–Ω–æ–º
async function showKanbanAsAdmin() {
    showPage('page-kanban');
    await loadKanbanData();
    startKanbanAutoRefresh();
}

function setupDragAndDrop(column) {
    column.addEventListener('dragover', (e) => {
        e.preventDefault();
        column.classList.add('drag-over');
    });
    
    column.addEventListener('dragleave', (e) => {
        if (!column.contains(e.relatedTarget)) {
            column.classList.remove('drag-over');
        }
    });
    
    column.addEventListener('drop', async (e) => {
        e.preventDefault();
        column.classList.remove('drag-over');
        
        if (!draggedCard) return;
        
        const orderId = draggedCard.dataset.orderId;
        const newProcess = column.dataset.process;
        
        // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑
        const order = kanbanOrders.find(o => o.id === orderId);
        if (!order) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å
        if (!canMoveToProcess(order, newProcess)) {
            showToast('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å', 'error');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å
        await updateOrderProcess(orderId, newProcess);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º Kanban
        await loadKanbanData();
        showToast('–ó–∞–∫–∞–∑ –ø–µ—Ä–µ–º–µ—â–µ–Ω', 'success');
    });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
function canMoveToProcess(order, targetProcess) {
    // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å "–†–æ–≤–µ—Ä", –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
    if (targetProcess === "–†–æ–≤–µ—Ä") {
        return false;
    }
    
    const currentIndex = KANBAN_PROCS.indexOf(order.current_process);
    const targetIndex = KANBAN_PROCS.indexOf(targetProcess);
    
    // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ—Å–µ–¥–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–ª–∏ –≤–ø–µ—Ä–µ–¥ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
    if (currentIndex === -1 || targetIndex === -1) return false;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ü–µ–ª–µ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å –≤ –º–∞—Ä—à—Ä—É—Ç–µ –∑–∞–∫–∞–∑–∞
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º "–†–æ–≤–µ—Ä" –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
    const validPath = order.path.filter(p => p !== "–†–æ–≤–µ—Ä");
    if (!validPath.includes(targetProcess)) return false;
    
    return true;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–∫–∞–∑–∞
async function updateOrderProcess(orderId, newProcess) {
    try {
        const order = kanbanOrders.find(o => o.id === orderId);
        if (!order) return;
        
        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –æ–Ω –±—ã–ª –Ω–∞—á–∞—Ç
        if (order.current_process && order.history?.[order.current_process]?.start && !order.history[order.current_process]?.end) {
            order.history[order.current_process].end = new Date().toISOString();
            
            // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            await _supabase.from('logs').insert({
                worker_name: 'Kanban System',
                order_id: orderId,
                process_name: order.current_process,
                action_type: 'finish',
                kanban_move: true
            });
        }
        
        // –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
        if (!order.history) order.history = {};
        if (!order.history[newProcess]) order.history[newProcess] = {};
        
        order.history[newProcess].start = new Date().toISOString();
        order.history[newProcess].kanban_moved = true;
        
        // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ
        await _supabase.from('logs').insert({
            worker_name: 'Kanban System',
            order_id: orderId,
            process_name: newProcess,
            action_type: 'start',
            kanban_move: true
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        const { error } = await _supabase
            .from('orders')
            .update({
                history: order.history
            })
            .eq('id', orderId);
            
        if (error) throw error;
        
    } catch (err) {
        console.error('Update process error:', err);
        showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞', 'error');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Kanban –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
function refreshKanban() {
    const searchTerm = document.getElementById('kanban-search')?.value.toLowerCase() || '';
    const filterType = document.getElementById('kanban-filter')?.value || 'all';
    
    let filteredOrders = [...kanbanOrders];
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
    if (searchTerm) {
        filteredOrders = filteredOrders.filter(order => 
            order.id.toLowerCase().includes(searchTerm) ||
            order.crm_client.toLowerCase().includes(searchTerm) ||
            order.crm_item.toLowerCase().includes(searchTerm)
        );
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    if (filterType === 'active') {
        filteredOrders = filteredOrders.filter(order => order.current_status === 'in-progress');
    } else if (filterType === 'delayed') {
        filteredOrders = filteredOrders.filter(order => order.days_in_process > 3);
    }
    
    // –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
    const originalOrders = kanbanOrders;
    kanbanOrders = filteredOrders;
    renderKanban();
    kanbanOrders = originalOrders;
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Kanban
function startKanbanAutoRefresh() {
    if (curUser && (curUser.name === 'kanban' || curUser.name === 'admin939291')) {
        setInterval(async () => {
            await loadKanbanData();
            console.log('Kanban –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω:', new Date().toLocaleTimeString());
        }, 30000); // 30 —Å–µ–∫—É–Ω–¥
    }
}

// --- GLOBAL HOTKEY FOR TV MODE ---
document.addEventListener('keydown', function(event) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é Ctrl + Space (Ctrl + –ü—Ä–æ–±–µ–ª)
    if (event.ctrlKey && event.code === 'Space') {
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Kanban
        const kanbanPage = document.getElementById('page-kanban');
        const isKanbanVisible = kanbanPage && !kanbanPage.classList.contains('hidden');
        
        // –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Kanban, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º TV —Ä–µ–∂–∏–º
        if (isKanbanVisible) {
            toggleTVMode();
            console.log('TV —Ä–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –ø–æ Ctrl+Space');
        }
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞ Kanban, –Ω–æ –≤ —Å–∏—Å—Ç–µ–º–µ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ Kanban –∏ –≤–∫–ª—é—á–∞–µ–º TV —Ä–µ–∂–∏–º
        else if (curUser && (curUser.name === 'kanban' || curUser.name === 'admin939291')) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É Kanban
            showPage('page-kanban');
            
            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å, –∑–∞—Ç–µ–º –≤–∫–ª—é—á–∞–µ–º TV —Ä–µ–∂–∏–º
            setTimeout(() => {
                if (!isTVMode()) {
                    enableTV4KMode();
                    showToast('TV —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω –ø–æ Ctrl+Space');
                }
                loadKanbanData();
            }, 100);
        }
    }
});

async function handleLogout() {
    // –õ–æ–≥–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
    if (curUser && curUser.name !== 'admin939291' && curUser.name !== 'kanban') {
        await logActivity(curUser.name, '–í—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã', '', 'logout');
    }
    
    // Clear Memory
    localStorage.removeItem('erp_user');
    localStorage.removeItem('erp_user_type');
    
    // Reload Page
    location.reload();
}

// --- WORKER LOGIC ---
function resetWorkerFlow() {
    curProc = null;
    document.getElementById('worker-action-card').classList.add('hidden');
    document.getElementById('worker-order-input').value = '';
    renderWorkerTasks();
}
function renderWorkerTasks() {
    const list = document.getElementById('worker-tasks-list');
    if(!list) return; list.innerHTML = '';
    
    let myProcs = curUser.procs || [];
    let myTasks = [];

    myProcs.forEach(proc => {
        orders.forEach(o => {
            if(o.path && o.path.includes(proc)) {
                const h = o.history && o.history[proc];
                if(!h || (!h.end && h.start)) {
                    myTasks.push({ order: o, proc: proc, status: h ? 'active' : 'pending' });
                }
            }
        });
    });

    const countBadge = document.getElementById('task-count-badge');
    if(countBadge) countBadge.innerText = myTasks.length;

    if(myTasks.length === 0) {
        list.innerHTML = '<div style="text-align:center; color: #94a3b8; padding: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
        return;
    }

    myTasks.forEach(task => {
        const el = document.createElement('div');
        el.className = 'task-item';
        const statusColor = task.status === 'active' ? 'background:#eef2ff; border-color:var(--primary)' : '';
        const statusText = task.status === 'active' ? '–í —Ä–∞–±–æ—Ç–µ' : '–û–∂–∏–¥–∞–µ—Ç';
        el.style.cssText = statusColor;
        el.innerHTML = `
            <div>
                <div>
                    <div style="font-weight:700; font-size: 16px;">#${task.order.id}</div>
                <div style="font-size: 12px; color:#64748b;">${task.proc}</div>
            </div>
            <div class="proc-badge ${task.status}">${statusText}</div>
        `;
        el.onclick = () => {
            selectWorkerProc(task.proc);
            document.getElementById('worker-order-input').value = task.order.id;
            workerFindOrder();
        };
        list.appendChild(el);
    });
}

function selectWorkerProc(p) {
    curProc = p;
    
    document.getElementById('active-proc-name').innerText = p;
    document.getElementById('worker-action-card').classList.remove('hidden');
    
    const currentInput = document.getElementById('worker-order-input').value.trim();
    
    if(currentInput) {
        const o = orders.find(x => x.id === currentInput);
        
        if(o && o.path.includes(p)) {
            document.getElementById('worker-controls').classList.remove('hidden');
            
            const h = o.history && o.history[p];
            const isStarted = !!h;
            const isFinished = isStarted && !!h.end;

            document.getElementById('btn-start').classList.toggle('hidden', isStarted);
            document.getElementById('btn-finish').classList.toggle('hidden', !isStarted || isFinished);
            document.getElementById('done-msg').classList.toggle('hidden', !isFinished);
        } else {
            document.getElementById('worker-controls').classList.add('hidden');
            showToast(`–ó–∞–∫–∞–∑ #${currentInput} –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —ç—Ç–∞–ø "${p}"`, "error");
        }
    } else {
        document.getElementById('worker-controls').classList.add('hidden');
        document.getElementById('worker-order-input').value = '';
        document.getElementById('worker-order-input').focus();
    }
}

function workerFindOrder() {
    const oid = document.getElementById('worker-order-input').value.trim();
    const o = orders.find(x => x.id === oid);
    if(!o || !o.path.includes(curProc)) return showToast("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");

    document.getElementById('worker-controls').classList.remove('hidden');
    const h = o.history && o.history[curProc];
    const isStarted = !!h;
    const isFinished = isStarted && !!h.end;

    document.getElementById('btn-start').classList.toggle('hidden', isStarted);
    document.getElementById('btn-finish').classList.toggle('hidden', !isStarted || isFinished);
    document.getElementById('done-msg').classList.toggle('hidden', !isFinished);
}

async function processAction(type) {
    const oid = document.getElementById('worker-order-input').value.trim();
    const o = orders.find(x => x.id === oid);
    if(!o) return;

    if(!o.history) o.history = {};
    if(!o.history[curProc]) o.history[curProc] = {};

    try {
        const timestamp = new Date().toISOString();
        if(type === 'start') {
            if(o.history[curProc].start) return showToast("–£–∂–µ –Ω–∞—á–∞—Ç–æ", "error");
            o.history[curProc] = { start: timestamp, worker: curUser.name };
            
            // Log process start
            await logActivity(curUser.name, '–ù–∞—á–∞–ª –ø—Ä–æ—Ü–µ—Å—Å', 
                `–ó–∞–∫–∞–∑ #${oid}, –ø—Ä–æ—Ü–µ—Å—Å: ${curProc}`, 'process');
        } else {
            if(!o.history[curProc].start) return showToast("–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ", "error");
            if(o.history[curProc].end) return showToast("–£–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", "error");
            o.history[curProc].end = timestamp;
            
            // Log process finish
            await logActivity(curUser.name, '–ó–∞–≤–µ—Ä—à–∏–ª –ø—Ä–æ—Ü–µ—Å—Å', 
                `–ó–∞–∫–∞–∑ #${oid}, –ø—Ä–æ—Ü–µ—Å—Å: ${curProc}`, 'process');
        }
        const { error } = await _supabase.from('orders').upsert(o);
        if(error) throw error;
        await loadAllData();
        workerFindOrder();
        showToast(type === 'start' ? "–†–∞–±–æ—Ç–∞ –Ω–∞—á–∞—Ç–∞" : "–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    } catch (err) {
        showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
    }
}

// --- ADMIN LOGIC ---
function renderDashboard() {
    const total = orders.length;
    const active = orders.filter(o => !isOrderFinished(o)).length;
    const finished = orders.filter(o => {
        if(!isOrderFinished(o)) return false;
        const lastStep = o.path[o.path.length-1];
        const h = o.history[lastStep];
        return h && new Date(h.end).toDateString() === new Date().toDateString();
    }).length;

    document.getElementById('stat-total').innerText = total;
    document.getElementById('stat-active').innerText = active;
    document.getElementById('stat-finished').innerText = finished;
}

function isOrderFinished(o) {
    if(!o.path || !o.history) return false;
    const lastStep = o.path[o.path.length-1];
    return !!o.history[lastStep]?.end;
}

function lookupCRMOrder(orderId) {
    const inputVal = orderId.trim();
    const resultCard = document.getElementById('crm-lookup-card');
    
    if(!inputVal) {
        resultCard.classList.add('hidden');
        return;
    }

    const orderData = crm_orders.find(c => c.oid === inputVal);

    if(orderData) {
        document.getElementById('lookup-client').innerText = orderData.client || '-';
        document.getElementById('lookup-item').innerText = orderData.item || '-';
        document.getElementById('lookup-price').innerText = (orderData.price || 0) + ' ‚Ç∏';
        document.getElementById('lookup-date').innerText = orderData.date || '–ù–µ—Ç –¥–∞—Ç—ã';
        
        resultCard.classList.remove('hidden');
    } else {
        resultCard.classList.add('hidden');
    }
}

function closeCRMLookup() {
    document.getElementById('crm-lookup-card').classList.add('hidden');
    document.getElementById('adm-o-id').value = '';
}

async function saveWorker() {
    const name = document.getElementById('adm-w-name').value.trim();
    const procs = Array.from(document.querySelectorAll('#adm-w-grid input:checked')).map(c => c.value);
    if(!name) return showToast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è", "error");
    if(procs.length === 0) return showToast("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã", "error");

    try {
        const isRenaming = editWId && editWId !== name;
        if (isRenaming) {
            await _supabase.from('workers').delete().eq('name', editWId);
            await _supabase.from('workers').insert({ name, procs });
            // Log worker update
            await logActivity(curUser.name, '–û–±–Ω–æ–≤–∏–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 
                `–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${name}, –¥–æ—Å—Ç—É–ø—ã: ${procs.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤`, 'worker');
            showToast(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ '${name}'`);
        } else {
            await _supabase.from('workers').upsert({ name, procs });
            // Log new worker
            await logActivity(curUser.name, '–°–æ–∑–¥–∞–ª –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 
                `–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${name}, –¥–æ—Å—Ç—É–ø—ã: ${procs.length} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤`, 'worker');
            showToast("–î–æ—Å—Ç—É–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
        }
        resetWorkerForm();
        await loadAllData();
    } catch (err) {
        showToast("–û—à–∏–±–∫–∞: " + err.message, "error");
    }
}

function editWorker(name) {
    const w = workers.find(x => x.name === name);
    if(!w) return;
    editWId = name;
    document.getElementById('adm-w-name').value = w.name;
    document.getElementById('worker-form-title').innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: " + name;
    document.getElementById('worker-form-container').classList.add('edit-mode-active');
    document.getElementById('btn-cancel-w').classList.remove('hidden');
    document.querySelectorAll('#adm-w-grid input').forEach(cb => {
        cb.checked = w.procs && w.procs.includes(cb.value);
    });
}

function resetWorkerForm() {
    editWId = null;
    document.getElementById('adm-w-name').value = '';
    document.getElementById('worker-form-title').innerText = "–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞";
    document.getElementById('worker-form-container').classList.remove('edit-mode-active');
    document.getElementById('btn-cancel-w').classList.add('hidden');
    document.querySelectorAll('#adm-w-grid input').forEach(cb => cb.checked = false);
}

function renderWorkers() {
    const tableBody = document.getElementById('w-table');
    if(!tableBody) return;
    tableBody.innerHTML = '';

    if(workers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</td></tr>';
        return;
    }

    tableBody.innerHTML = workers.map(w => {
        const procsList = Array.isArray(w.procs) ? w.procs : [];
        return `
        <tr>
            <td><b>${w.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</b></td>
            <td>${procsList.map(p => `<span class="proc-badge">${p}</span>`).join('')}</td>
            <td>
                <button class="btn-ghost" onclick="editWorker('${w.name}')">‚úèÔ∏è</button>
                <button class="btn-red" onclick="delW('${w.name}')">‚úñ</button>
            </td>
        </tr>`;
    }).join('');
}

function renderMonitor() {
    const tableBody = document.getElementById('m-table');
    if (!tableBody) return;
    
    let rows = orders.map(o => {
        const totalSteps = (o.path || []).length;
        const finishedSteps = totalSteps > 0 ?
            (o.path || []).filter(p => o.history && o.history[p] && o.history[p].end).length : 0;
        const progress = totalSteps > 0 ? Math.round((finishedSteps / totalSteps) * 100) : 0;

        const stepsHtml = (o.path || []).map(p => {
            const status = getOrderStatus(o, p);
            return `<span class="state-badge ${status.status}">${status.text}</span>`;
        }).join(' ');

        return `
        <tr>
            <td>
                <b>#${o.id}</b><br>
                <button class="btn-blue" style="padding: 2px 8px; font-size: 10px; margin-top: 5px;" onclick="openOrderDetails('${o.id}')">‚ÑπÔ∏è –ò–Ω—Ñ–æ</button>
            </td>
            <td>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="flex:1; min-width:100px; height:6px; background:#e2e8f0; border-radius: 3px; overflow:hidden;">
                            <div style="width:${progress}%; background:var(--primary); height:100%;"></div>
                        </div>
                        <span style="font-size:12px; font-weight:600;">${progress}%</span>
                    </div>
                    <div style="font-size: 11px; color:#64748b; line-height: 1.4;">
                        ${stepsHtml}
                    </div>
                </div>
            </td>
            <td><button class="btn-red" onclick="delO('${o.id}')">‚úñ</button></td>
        </tr>`;
    }).join('');

    tableBody.innerHTML = rows;
}

function renderCRM() {
    document.getElementById('crm-table-body').innerHTML = crm_orders.map(c => `
        <tr style="cursor:pointer;" onclick="copyToProduction('${c.oid}')">
            <td>#${c.oid}</td>
            <td>${c.client || '-'}</td>
            <td>${c.item || '-'}</td>
            <td>${c.price || 0}</td>
            <td>
                <button class="btn-red" onclick="event.stopPropagation(); delCRM('${c.oid}')">‚úñ</button>
            </td>
        </tr>`).join('');
}

function copyToProduction(oid) {
    showPage('page-orders');
    document.getElementById('adm-o-id').value = oid;
    lookupCRMOrder(oid);
    
    // Log copy to production
    logActivity(curUser.name, '–ö–æ–ø–∏—Ä–æ–≤–∞–ª –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', 
        `–ó–∞–∫–∞–∑ CRM #${oid}`, 'crm');
}

async function saveCRM() {
    const oid = document.getElementById('crm-oid').value.trim();
    if(!oid) return showToast("–í–≤–µ–¥–∏—Ç–µ ‚Ññ", "error");
    try {
        await _supabase.from('crm_orders').upsert({ 
            oid, 
            client: document.getElementById('crm-client').value, 
            item: document.getElementById('crm-item').value, 
            price: document.getElementById('crm-price').value 
        });
        
        // Log CRM order creation
        await logActivity(curUser.name, '–°–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑ CRM', 
            `–ó–∞–∫–∞–∑ #${oid}, –∫–ª–∏–µ–Ω—Ç: ${document.getElementById('crm-client').value}`, 'crm');
            
        ['crm-oid','crm-client','crm-item','crm-price'].forEach(id => document.getElementById(id).value = '');
        await loadAllData();
        showToast("–ó–∞–∫–∞–∑ –≤ CRM");
    } catch (err) { showToast("–û—à–∏–±–∫–∞", "error"); }
}

async function saveOrder() {
    const id = document.getElementById('adm-o-id').value.trim();
    const path = Array.from(document.querySelectorAll('#adm-o-grid input:checked')).map(cb => cb.value);
    if(!id) return showToast("–í–≤–µ–¥–∏—Ç–µ ‚Ññ", "error");
    try {
        const existing = orders.find(x => x.id === id);
        
        const payload = { id, path };
        if (!existing) payload.history = {};
        else payload.history = existing.history || {};
        
        await _supabase.from('orders').upsert(payload);
        
        // Log production order creation
        await logActivity(curUser.name, '–ó–∞–ø—É—Å—Ç–∏–ª –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ', 
            `–ó–∞–∫–∞–∑ #${id}, –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: ${path.length}`, 'order');
            
        document.getElementById('adm-o-id').value = '';
        document.querySelectorAll('#adm-o-grid input:checked').forEach(cb => cb.checked = false);
        await loadAllData();
        showToast("–ó–∞–∫–∞–∑ –∑–∞–ø—É—â–µ–Ω");
    } catch (err) { showToast("–û—à–∏–±–∫–∞", "error"); }
}

function openOrderDetails(orderId) {
    const order = orders.find(o => o.id === orderId);
    const crmData = crm_orders.find(c => c.oid === orderId);

    if(!order) return alert("–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ");
    
    document.getElementById('modal-order-id').innerText = `#${order.id}`;
    
    const content = document.getElementById('modal-order-content');
    
    let crmHtml = '';
    if(crmData) {
        crmHtml = `
            <div style="background: #eff6ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #bfdbfe;">
                <b>üìã –î–∞–Ω–Ω—ã–µ CRM:</b>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                    <span>–ö–ª–∏–µ–Ω—Ç:</span> <b>${crmData.client || '-'}</b>
                    <span>–¢–æ–≤–∞—Ä:</span> <b>${crmData.item || '-'}</b>
                    <span>–°—É–º–º–∞:</span> <b>${crmData.price || '-'} ‚Ç∏</b>
                    <span>–î–∞—Ç–∞:</span> <b>${crmData.date || '-'}</b>
                </div>
            </div>`;
    }

    let stepsHtml = (order.path || []).map(p => {
        const status = getOrderStatus(order, p);
        return `<div style="display:flex; justify-content:space-between; border-bottom: 1px solid #f1f5f9; padding: 8px 0;">
                    <span>${p}</span>
                    <span class="state-badge ${status.status}">${status.text}</span>
                </div>`;
    }).join('');

    content.innerHTML = crmHtml + `<div><b>–ú–∞—Ä—à—Ä—É—Ç –∏ –°—Ç–∞—Ç—É—Å:</b><br><br>${stepsHtml}</div>`;
    
    document.getElementById('search-modal').classList.remove('hidden');
}

async function delW(n) { 
    if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) { 
        // Log deletion
        await logActivity(curUser.name, '–£–¥–∞–ª–∏–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', 
            `–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${n}`, 'delete');
        await _supabase.from('workers').delete().eq('name', n);
        await loadAllData(); 
    } 
}

async function delO(id) { 
    if(confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑?")) { 
        // Log deletion
        await logActivity(curUser.name, '–£–¥–∞–ª–∏–ª –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑', 
            `–ó–∞–∫–∞–∑ #${id}`, 'delete');
        await _supabase.from('orders').delete().eq('id', id);
        await loadAllData(); 
    } 
}

async function delCRM(id) { 
    if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ CRM?")) { 
        // Log deletion
        await logActivity(curUser.name, '–£–¥–∞–ª–∏–ª –∑–∞–∫–∞–∑ CRM', 
            `–ó–∞–∫–∞–∑ #${id}`, 'delete');
        await _supabase.from('crm_orders').delete().eq('oid', id);
        await loadAllData(); 
    } 
}

function showPage(id) {
    document.querySelectorAll('.page, #page-worker-terminal, #page-login, #page-kanban').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const target = document.getElementById(id);
    if(target) target.classList.remove('hidden');
    
    // Log page navigation for admin
    if (curUser && curUser.name === 'admin939291' && id !== 'page-dashboard') {
        const pageNames = {
            'page-workers': '–ü–µ—Ä—Å–æ–Ω–∞–ª',
            'page-crm': 'CRM',
            'page-orders': '–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ',
            'page-monitor': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥',
            'page-dashboard': '–û–±–∑–æ—Ä',
            'page-kanban': 'Kanban –¥–æ—Å–∫–∞'
        };
        if (pageNames[id]) {
            logActivity(curUser.name, '–ü–µ—Ä–µ—à–µ–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É', 
                `–°—Ç—Ä–∞–Ω–∏—Ü–∞: ${pageNames[id]}`, 'system');
        }
    }
}

function openGlobalSearch() {
    const query = document.getElementById('global-search-input').value.trim();
    if(!query) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä");
    const order = orders.find(o => o.id === query);
    if(!order) return alert("–ù–µ –Ω–∞–π–¥–µ–Ω");
    
    document.getElementById('modal-order-id').innerText = order.id;
    const content = document.getElementById('modal-order-content');
    if(!order.path) { content.innerHTML = "–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞"; } 
    else {
        content.innerHTML = order.path.map(p => {
            const status = getOrderStatus(order, p);
            return `<div style="display:flex; justify-content:space-between; border-bottom: 1px solid #f1f5f9; padding: 8px 0;">
                        <span>${p}</span>
                        <span class="state-badge ${status.status}">${status.text}</span>
                    </div>`;
        }).join('');
    }
    document.getElementById('search-modal').classList.remove('hidden');
    
    // Log search activity
    logActivity(curUser?.name || '–ì–æ—Å—Ç—å', '–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞', 
        `–ó–∞–∫–∞–∑ #${query}`, 'system');
}
function closeGlobalSearch() { document.getElementById('search-modal').classList.add('hidden'); }

function init() {
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
    
    try {
        // 1. Generate Grids
        const wg = document.getElementById('adm-w-grid');
        const og = document.getElementById('adm-o-grid');
        if(wg && og) {
            wg.innerHTML = ''; og.innerHTML = '';
            PROCS.forEach(p => {
                if (p) {
                    wg.innerHTML += `<label class="item-card"><input type="checkbox" value="${p}"> ${p}</label>`;
                    og.innerHTML += `<label class="item-card"><input type="checkbox" value="${p}"> ${p}</label>`;
                }
            });
        }

        // 2. Load Data
        loadAllData().then(() => {
            console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            
            // 3. CHECK SESSION
            const savedUser = localStorage.getItem('erp_user');
            const savedUserType = localStorage.getItem('erp_user_type');
            
            if(savedUser) {
                // Set input value
                const loginInput = document.getElementById('login-input');
                if (loginInput) {
                    loginInput.value = savedUser;
                }
                
                // Handle login based on user type
                if (savedUser === 'kanban' || savedUserType === 'kanban') {
                    // –ü—Ä—è–º–æ–π –≤—Ö–æ–¥ –≤ Kanban
                    curUser = { name: 'kanban' };
                    document.getElementById('page-login').classList.add('hidden');
                    document.getElementById('admin-nav').style.display = 'none';
                    document.getElementById('page-kanban').classList.remove('hidden');
                    document.getElementById('logout-btn').classList.remove('hidden');
                    
                    loadKanbanData().then(() => {
                        startKanbanAutoRefresh();
                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Kanban:', err);
                    });
                } else if (savedUser === 'admin939291' || savedUserType === 'admin') {
                    // –í—Ö–æ–¥ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                    curUser = { name: 'admin939291' };
                    document.getElementById('page-login').classList.add('hidden');
                    document.getElementById('admin-nav').style.display = 'flex';
                    document.getElementById('admin-nav').classList.add('mobile-active');
                    document.getElementById('logout-btn').classList.remove('hidden');
                    showPage('page-dashboard');
                } else if (savedUserType === 'worker') {
                    // –í—Ö–æ–¥ –∫–∞–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫
                    const worker = workers.find(w => w.name === savedUser);
                    if (worker) {
                        curUser = worker;
                        document.getElementById('page-login').classList.add('hidden');
                        document.getElementById('admin-nav').style.display = 'none';
                        document.getElementById('page-worker-terminal').classList.remove('hidden');
                        document.getElementById('logout-btn').classList.remove('hidden');
                        document.getElementById('worker-title').innerText = worker.name;
                        renderWorkerTasks();
                    } else {
                        // –†–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º
                        handleLogout();
                    }
                }
            }
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã', 'error');
        });
        
    } catch (err) {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
        showToast('–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞', 'error');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', () => {
    init();
    updateScreenSize();
    autoDetectTVMode();
});

// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', () => {
    setTimeout(() => {
        updateScreenSize();
        autoDetectTVMode();
    }, 500);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Kanban –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const searchInput = document.getElementById('kanban-search');
    const sortSelect = document.getElementById('kanban-sort');
    const filterSelect = document.getElementById('kanban-filter');
    
    if (searchInput) {
        searchInput.addEventListener('input', refreshKanban);
    }
    if (sortSelect) {
        sortSelect.addEventListener('change', refreshKanban);
    }
    if (filterSelect) {
        filterSelect.addEventListener('change', refreshKanban);
    }
});
</script>
</body>
</html>